<!doctype html>
<html>
  <head>
  <base href="/">
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, user-scalable=no">
    <title>ANATALEB</title>

    <!-- Minimal critical CSS & preinit state -->
    <style>
      /* Keep background stable and app hidden until we're truly ready */
      html.preinit, html.preinit body { background:#fff; }
      html.preinit app-root { opacity: 0; visibility: hidden; }
      
      /* Smooth fade-in when ready */
      html:not(.preinit) app-root { 
        opacity: 1; 
        visibility: visible;
        transition: opacity 0.3s ease-in;
      }
      
      #preloader { 
        position:fixed; 
        inset:0; 
        display:flex; 
        flex-direction: column;
        align-items:center; 
        justify-content:center;
        background:#fff; 
        z-index:9999; 
        font:600 14px system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
        transition: opacity 0.3s ease-out;
      }
      
      #preloader.hide { 
        opacity: 0;
        pointer-events: none;
      }
      
      #preloader.removed {
        display: none;
      }
      
      /* Loading text */
      #preloader .loading-text {
        margin-top: 16px;
        color: #2563EB;
        font-size: 16px;
        font-weight: 600;
      }
      
      /* Clear cache button (shown after 3 seconds if stuck) */
      #preloader .clear-cache-btn {
        margin-top: 24px;
        padding: 10px 20px;
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        opacity: 0;
        transition: opacity 0.3s ease-in;
        box-shadow: 0 2px 8px rgba(220, 38, 38, 0.3);
      }
      
      #preloader .clear-cache-btn:hover {
        background: #b91c1c;
        box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
      }
      
      #preloader.show-clear-btn .clear-cache-btn {
        opacity: 1;
      }
    </style>

    
    <!-- Set lang/dir BEFORE any render and handle cache clearing -->
    <script>
      (function () {
        try {
          // Check if we need to clear all data (for production stuck state fix)
          var shouldClearCache = sessionStorage.getItem('anataleb.clearCache');
          
          if (shouldClearCache === 'true') {
            try {
              // Clear all cookies
              document.cookie.split(";").forEach(function(c) {
                document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/");
              });
              
              // Clear sessionStorage
              sessionStorage.clear();
              
              // Clear localStorage
              localStorage.clear();
              
              // Remove the flag itself
              sessionStorage.removeItem('anataleb.clearCache');
              
              console.log('‚úÖ All cookies, localStorage, and sessionStorage cleared');
            } catch(err) {
              console.error('Error clearing cache:', err);
            }
          }
          
          document.documentElement.classList.add('preinit');
          var saved = sessionStorage.getItem('anataleb.lang');
          var lang = (saved === 'en' || saved === 'ar') ? saved : 'ar'; // Default to Arabic
          var dir  = (lang === 'ar') ? 'rtl' : 'ltr';
          var el   = document.documentElement;
          el.setAttribute('lang', lang);
          el.setAttribute('dir',  dir);
          window.__ANATALEB_STARTUP_LANG__ = lang; // used in app.config.ts
          
          // Load Google Identity Services with the detected language
          var gisScript = document.createElement('script');
          gisScript.src = 'https://accounts.google.com/gsi/client?hl=' + lang;
          gisScript.async = true;
          gisScript.defer = true;
          document.head.appendChild(gisScript);
        } catch(e) {}
      })();
    </script>
    
    <!-- Cache clearing helper for production issues -->
    <script>
      // Add this function to window for manual clearing if needed
      window.clearAnatalebCache = function() {
        sessionStorage.setItem('anataleb.clearCache', 'true');
        console.log('üîÑ Cache clearing flag set. Refresh the page to clear all data.');
        alert('Cache clearing enabled. The page will reload and clear all cookies, localStorage, and sessionStorage.');
        setTimeout(function() {
          window.location.reload(true);
        }, 500);
      };
      
      // Add keyboard shortcut: Ctrl+Shift+K to clear cache
      document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.shiftKey && e.key === 'K') {
          e.preventDefault();
          if (confirm('Clear all cookies, localStorage, and sessionStorage and reload?')) {
            window.clearAnatalebCache();
          }
        }
      });
      
      // Show clear cache button after 3 seconds if loading takes too long
      var preloader = document.getElementById('preloader');
      setTimeout(function() {
        if (preloader && !preloader.classList.contains('hide')) {
          preloader.classList.add('show-clear-btn');
        }
      }, 3000);
      
      // Clear cache and reload function
      window.clearCacheAndReload = function() {
        sessionStorage.setItem('anataleb.clearCache', 'true');
        console.log('üîÑ Clearing cache and reloading...');
        window.location.reload(true);
      };
    </script>
  </head>
  <body>
    <!-- Branded preloader with spinner and text -->
<div id="preloader" role="status" aria-live="polite" aria-label="Loading AnaTaleb">
  <div class="spinner" aria-hidden="true"></div>
  <div class="loading-text">Loading AnaTaleb...</div>
  <button class="clear-cache-btn" onclick="clearCacheAndReload()" type="button">
    Clear Cache & Reload
  </button>
  <span class="sr-only">Loading, please wait</span>
</div>

    <app-root></app-root>


    <!-- Reveal app when Angular + i18n + fonts are ready -->
    <script>
      var hasRevealed = false;
      var reveal = function () {
        if (hasRevealed) return;
        hasRevealed = true;
        
        var p = document.getElementById('preloader');
        
        // Step 1: Remove preinit class to start app fade-in
        document.documentElement.classList.remove('preinit');
        
        // Step 2: Hide preloader with fade-out
        if (p) {
          p.classList.add('hide');
          
          // Step 3: Remove preloader from DOM after fade-out completes
          setTimeout(function() {
            if (p) p.classList.add('removed');
          }, 300); // Match CSS transition duration
        }
      };
      
      // Listen for the ready event
      var minDisplayTime = 1200; // Minimum display time: 1.2 seconds
      var startTime = Date.now();
      
      window.addEventListener('AnatalebReady', function(){
        // Wait for fonts to be ready before revealing
        var elapsed = Date.now() - startTime;
        var remainingTime = Math.max(0, minDisplayTime - elapsed);
        
        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(function() {
            // Extra delay to ensure content is painted and meet minimum display time
            setTimeout(reveal, Math.max(300, remainingTime));
          }).catch(function() {
            setTimeout(reveal, Math.max(300, remainingTime));
          });
        } else { 
          setTimeout(reveal, Math.max(300, remainingTime));
        }
      });
      
      // Fallback timeout to prevent infinite loading
      setTimeout(function() {
        if (!hasRevealed) {
          console.warn('App ready timeout - revealing anyway');
          // If stuck for 5 seconds, try clearing cache and reloading
          if (sessionStorage.getItem('anataleb.retryCount') === null) {
            sessionStorage.setItem('anataleb.retryCount', '1');
            sessionStorage.setItem('anataleb.clearCache', 'true');
            console.warn('‚ö†Ô∏è App stuck in loading. Clearing cache and reloading...');
            setTimeout(function() {
              window.location.reload(true);
            }, 1000);
          } else {
            // Already tried once, just reveal the app
            sessionStorage.removeItem('anataleb.retryCount');
            reveal();
          }
        }
      }, 5000); // Increased timeout for lazy-loaded routes
    </script>
  </body>
</html>

<style>
  /* Spinner */
  .spinner{
    inline-size:48px; block-size:48px;         /* 48x48 circle */
    border-radius:50%;
    border:3px solid #e9eef7;                  /* track */
    border-top-color:#2563EB;                  /* brand blue */
    animation:spin .8s linear infinite;
  }

  /* Accessible hidden text for screen readers */
  .sr-only{
    position:absolute !important;
    width:1px !important; height:1px !important;
    padding:0 !important; margin:-1px !important;
    overflow:hidden !important; clip:rect(0,0,0,0) !important;
    white-space:nowrap !important; border:0 !important;
  }

  @keyframes spin{
    to { transform: rotate(360deg); }
  }

  /* Respect users who prefer reduced motion */
  @media (prefers-reduced-motion:reduce){
    .spinner{ animation: none; border-top-color:#2563EB }
  }
</style>
