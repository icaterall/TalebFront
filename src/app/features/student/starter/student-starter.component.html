<div class="starter-page" [dir]="isRTL ? 'rtl' : 'ltr'">
  
  <!-- Vibrant Hero Header with Gradient -->
  <div class="hero-header">
    <div class="decorative-shapes">
      <div class="shape-pattern"></div>
      <div class="shape-circle-1"></div>
      <div class="shape-circle-2"></div>
    </div>
    
    <div class="hero-content">
      <div class="badge-group">
        <span class="badge">🎓 {{ stageName }}</span>
        <span class="badge">🌍 {{ countryName }}</span>
      </div>
      <h1>{{ currentLang === 'ar' ? '✨ أنشئ درسك مع الذكاء الاصطناعي' : '✨ Create Your Course with AI' }}</h1>
      <p class="hero-subtitle">
        {{ currentLang === 'ar' 
          ? 'اختر موضوعًا واحدًا وسيساعدك الذكاء الاصطناعي في بناء درس احترافي خطوة بخطوة.'
          : 'Pick one topic and AI will help you build a professional course step by step.' }}
      </p>
    </div>
  </div>

  <!-- Wizard Card Overlapping Hero -->
  <div class="wizard-card">
    <div class="wizard-card-inner">
    <!-- Wizard Progress -->
    <div class="wizard-progress">
      <div class="progress-step" [ngClass]="{'completed': step2Locked || currentStep > 1, 'current': currentStep === 1 && !step2Locked}">
        <div class="step-circle">
          <ng-container *ngIf="step2Locked || currentStep > 1; else stepOne">
            <span class="check-icon">✔</span>
          </ng-container>
          <ng-template #stepOne>1</ng-template>
        </div>
        <div class="step-labels">
          <span class="step-name">{{ currentLang === 'ar' ? 'التصنيف' : 'Category' }}</span>
        </div>
      </div>
      <div class="progress-step" [ngClass]="{'completed': currentStep > 2, 'current': currentStep === 2, 'pending': currentStep < 2}">
        <div class="step-circle">
          <ng-container *ngIf="currentStep > 2; else stepTwo">
            <span class="check-icon">✔</span>
          </ng-container>
          <ng-template #stepTwo>2</ng-template>
        </div>
        <div class="step-labels">
          <span class="step-name">{{ currentLang === 'ar' ? 'أساسيات المقرر' : 'Course Basics' }}</span>
        </div>
      </div>
      <div class="progress-step pending">
        <div class="step-circle">3</div>
        <div class="step-labels">
          <span class="step-name">{{ currentLang === 'ar' ? 'بناء الوحدة الأولى' : 'Build First Unit' }}</span>
        </div>
      </div>
      <div class="progress-step pending">
        <div class="step-circle">4</div>
        <div class="step-labels">
          <span class="step-name">{{ currentLang === 'ar' ? 'مراجعة ونشر' : 'Review & Publish' }}</span>
        </div>
      </div>
    </div>

    <!-- Wizard Body -->
    <div class="wizard-body">
      <!-- Step 1: Category Selection -->
      <div *ngIf="showStep1" class="step-content step1-content">
        <!-- Read-only Summary (shown when step2Locked is true) -->
        <div class="read-only-summary" *ngIf="step2Locked && selectedCategory" [dir]="isRTL ? 'rtl' : 'ltr'">
          <div class="summary-item">
            <span class="summary-label">{{ currentLang === 'ar' ? 'التصنيف:' : 'Category:' }}</span>
            <span class="summary-icon">{{ selectedCategory.icon }}</span>
            <span class="summary-value">{{ getCategoryName(selectedCategory) }}</span>
          </div>
          <div class="summary-item">
            <span class="summary-label">{{ currentLang === 'ar' ? 'اسم المقرر:' : 'Course Name:' }}</span>
            <span class="summary-value">{{ courseName }}</span>
          </div>
          <div class="summary-item" *ngIf="selectedTopic || subjectSlug">
            <span class="summary-label">{{ currentLang === 'ar' ? 'الوحدة:' : 'Topic:' }}</span>
            <span class="summary-value">{{ selectedTopic || subjectSlug }}</span>
          </div>
        </div>

        <!-- Selected Category Display (Box style with Change button - shown in Step 1) -->
        <div class="selected-display" *ngIf="selectedCategory && !step2Locked">
          <div class="selected-badge">
            <span class="selected-icon">{{ selectedCategory.icon }}</span>
            <div class="selected-info">
              <span class="selected-label">{{ currentLang === 'ar' ? 'الموضوع المختار' : 'Selected Category' }}</span>
              <span class="selected-name">{{ getCategoryName(selectedCategory) }}</span>
            </div>
            <button class="change-btn" (click)="clearCategorySelection()">
              {{ currentLang === 'ar' ? 'تغيير' : 'Change' }}
            </button>
          </div>
        </div>

        <!-- Course Title Section (Shows after category selection) -->
        <div class="course-title-section" *ngIf="selectedCategory && !step2Locked">
          <!-- Loading Spinner - hidden when locked -->
          <div class="loading-container" *ngIf="!step2Locked && loadingTitles">
            <div class="spinner"></div>
            <p class="loading-text">{{ currentLang === 'ar' ? 'جاري تحميل اقتراحات الأسماء...' : 'Loading course name suggestions...' }}</p>
          </div>

          <!-- AI Title Suggestions (Cards) - hidden when locked - shown at top -->
          <div class="title-cards-container" *ngIf="!step2Locked && !loadingTitles && courseTitleSuggestions.length > 0">
            <div class="title-cards-grid">
              <div
                *ngFor="let titleCard of courseTitleSuggestions"
                class="title-card"
                [class.selected]="courseName === titleCard.title"
                (click)="selectTitleSuggestion(titleCard)">
                <div class="title-card-header">
                  <h3 class="title-card-title">{{ titleCard.title }}</h3>
                  <div class="title-card-info" *ngIf="titleCard.rationale" [title]="titleCard.rationale">
                    <span class="info-icon">ℹ️</span>
                  </div>
                </div>
                <p class="title-card-rationale" *ngIf="titleCard.rationale">{{ titleCard.rationale }}</p>
              </div>
            </div>
          </div>

          <!-- Course Name Input with AI Generate Button -->
          <div class="field-group course-name-input-group" *ngIf="!step2Locked">
            <label class="field-label">
              {{ currentLang === 'ar' ? 'اسم المقرر' : 'Course Name' }}
              <span class="required">*</span>
            </label>
            <div class="course-name-input-row">
              <input
                type="text"
                class="course-name-input"
                [(ngModel)]="courseName"
                (input)="onCourseNameChange()"
                [placeholder]="currentLang === 'ar' ? 'أدخل اسم المقرر...' : 'Enter course name...'"
                maxlength="80" />
              <button
                type="button"
                class="btn-generate-ai"
                *ngIf="!loadingTitles && courseTitleSuggestions.length === 0"
                (click)="loadTitleSuggestions()"
                [disabled]="loadingTitles">
                <span class="ai-icon">🤖</span>
                <span class="btn-text">{{ currentLang === 'ar' ? 'إنشاء بالذكاء الاصطناعي' : 'Generate with AI' }}</span>
              </button>
            </div>
            <div class="field-help">
              <span *ngIf="courseTitleSuggestions.length === 0">
                {{ currentLang === 'ar' ? 'اكتب اسم المقرر يدوياً أو انقر على الزر لإنشاء اقتراحات بالذكاء الاصطناعي' : 'Type the course name manually or click the button to generate suggestions with AI' }}
              </span>
              <span *ngIf="courseTitleSuggestions.length > 0">
                {{ currentLang === 'ar' ? 'اختر عنواناً من الاقتراحات أعلاه أو اكتب اسم المقرر يدوياً' : 'Select a title from suggestions above or type the course name manually' }}
              </span>
            </div>
          </div>

          <!-- Topic Selection (shown when title card is selected in Step 1) -->
          <!-- Show topic field only if AI was not used (manual course name entry) -->
          <div class="field-group" *ngIf="courseName && !step2Locked && courseTitleSuggestions.length === 0">
            <label class="field-label" *ngIf="!selectedTopic">
              {{ currentLang === 'ar' ? 'الوحدة' : 'Topic' }}
              <span class="required">*</span>
            </label>

            <!-- Stored Topic (one line with underline) - only show when locked (after Continue) -->
            <div class="inline-field-display" *ngIf="selectedTopic && step2Locked" [dir]="isRTL ? 'rtl' : 'ltr'">
              <span class="inline-label">{{ currentLang === 'ar' ? 'الوحدة:' : 'Topic:' }}</span>
              <span class="inline-value underlined">{{ selectedTopic }}</span>
            </div>

            <!-- Manual Topic Input (shown when no AI was used) -->
            <div class="topics-section" *ngIf="courseName && !step2Locked && !selectedTopic">
              <div class="topic-input-wrapper">
                <input
                  type="text"
                  class="topic-input-manual"
                  [(ngModel)]="subjectSlug"
                  (input)="onSubjectSlugChange()"
                  [placeholder]="currentLang === 'ar' ? 'أدخل الوحدة...' : 'Enter topic...'"
                  maxlength="100" />
              </div>
              <div class="field-help">
                {{ currentLang === 'ar' ? 'اكتب اسم الوحدة يدوياً' : 'Enter the topic name manually' }}
              </div>
            </div>
          </div>

          <!-- Topic Selection Cards (shown when AI title card is selected) -->
          <div class="field-group" *ngIf="courseName && !step2Locked && courseTitleSuggestions.length > 0 && availableTopics.length > 0">
            <label class="field-label" *ngIf="!selectedTopic">
              {{ currentLang === 'ar' ? 'الوحدة' : 'Topic' }}
              <span class="required">*</span>
            </label>

            <!-- Stored Topic (one line with underline) - only show when locked (after Continue) -->
            <div class="inline-field-display" *ngIf="selectedTopic && step2Locked" [dir]="isRTL ? 'rtl' : 'ltr'">
              <span class="inline-label">{{ currentLang === 'ar' ? 'الوحدة:' : 'Topic:' }}</span>
              <span class="inline-value underlined">{{ selectedTopic }}</span>
            </div>

            <!-- Topic Selection Cards (shown until Continue is clicked) -->
            <div class="topics-section" *ngIf="courseName && !step2Locked && availableTopics.length > 0">
              <div class="topics-grid">
                <div
                  *ngFor="let topic of availableTopics; let i = index"
                  class="topic-card"
                  [class.selected]="selectedTopic === topic && editingTopic !== topic"
                  [class.editing]="editingTopic === topic"
                  (click)="selectTopic(topic)">
                  <ng-container *ngIf="editingTopic === topic; else topicDisplayStep1">
                    <input
                      type="text"
                      class="topic-input"
                      [(ngModel)]="editingTopicValue"
                      (click)="$event.stopPropagation()"
                      (keyup.enter)="saveTopicEdit()"
                      (keyup.escape)="cancelTopicEdit()"
                      [placeholder]="currentLang === 'ar' ? 'أدخل الوحدة...' : 'Enter topic...'"
                      (blur)="saveTopicEdit()" />
                  </ng-container>
                  <ng-template #topicDisplayStep1>
                    <div class="topic-content">
                      <span class="topic-text">{{ topic }}</span>
                    </div>
                  </ng-template>
                </div>
              </div>
              <div class="field-help">
                {{ currentLang === 'ar' ? 'اختر وحدة واحدة أو انقر للتعديل' : 'Select one topic or click to edit' }}
              </div>
            </div>
          </div>

        </div>

        <!-- Category Selection (hidden when step2Locked) -->
        <div *ngIf="!selectedCategory && !step2Locked" class="search-section">
        <div class="card-header">
          <h2>📚 {{ currentLang === 'ar' ? 'اختر الموضوع' : 'Choose Your Category' }}</h2>
          <p>{{ currentLang === 'ar' ? 'الأكثر صلة بمرحلتك الدراسية' : 'Most relevant for your education stage' }}</p>
        </div>

        <!-- Loading Skeleton -->
        <div class="categories-grid" *ngIf="loading">
          <div class="cat-box skeleton" *ngFor="let i of [1,2,3,4,5,6]"></div>
        </div>

        <!-- Smart Six Categories -->
        <div class="categories-grid" *ngIf="!loading && smartSix.length > 0">
          <div
            *ngFor="let cat of smartSix"
            class="cat-box"
            (click)="selectCategory(cat)">
            <span class="cat-icon">{{ cat.icon }}</span>
            <span class="cat-name">{{ getCategoryName(cat) }}</span>
          </div>
        </div>

        <!-- Search Other Categories -->
        <div class="search-header">
          <span class="search-icon">🔍</span>
          <h3>{{ currentLang === 'ar' ? 'أو ابحث عن موضوع آخر' : 'Or search for another category' }}</h3>
        </div>
        <ng-select
          [items]="allCategories"
          [bindLabel]="currentLang === 'ar' ? 'name_ar' : 'name_en'"
          bindValue="id"
          [searchable]="true"
          [clearable]="true"
          [placeholder]="currentLang === 'ar' ? 'ابحث عن موضوع...' : 'Search for a category...'"
          [(ngModel)]="selectedCategoryId"
          (change)="onNgSelectChange()">
          <ng-template ng-option-tmp let-item="item">
            <div class="select-option">
              <span class="opt-icon">{{ item.icon }}</span>
              <span class="opt-name">{{ getCategoryName(item) }}</span>
            </div>
          </ng-template>
        </ng-select>
        </div>
      </div>

      <!-- Step 2: Course Basics -->
      <div *ngIf="showStep2" class="step-content step2-content">
        <!-- Header with Change Category Link -->
        <div class="step2-header">
          <button class="change-category-link" (click)="goBack()" *ngIf="selectedCategory">
            <span class="link-icon">←</span>
            {{ currentLang === 'ar' ? 'تغيير التصنيف' : 'Change Category' }}
          </button>
        </div>

        <!-- Category Info - Always show if category is selected -->
        <div class="category-info-wrapper" *ngIf="selectedCategory">
          <div class="field-group category-display-group">
            <div class="inline-field-display" [dir]="isRTL ? 'rtl' : 'ltr'">
              <span class="inline-label">{{ currentLang === 'ar' ? 'التصنيف:' : 'Category:' }}</span>
              <span class="inline-icon">{{ selectedCategory.icon }}</span>
              <span class="inline-value">{{ getCategoryName(selectedCategory) }}</span>
            </div>
          </div>
        </div>

        <!-- A) Course Name -->
        <div class="field-group">
          <label class="field-label" *ngIf="!courseName">
            {{ currentLang === 'ar' ? 'اسم المقرر' : 'Course Name' }}
            <span class="required">*</span>
          </label>

          <!-- Stored Course Name (one line with underline) -->
          <div class="inline-field-display" *ngIf="courseName" [dir]="isRTL ? 'rtl' : 'ltr'">
            <span class="inline-label">{{ currentLang === 'ar' ? 'اسم المقرر:' : 'Course Name:' }}</span>
            <span class="inline-value underlined">{{ courseName }}</span>
          </div>

          <!-- AI Title Suggestions (Cards) -->
          <div class="title-cards-container" *ngIf="!courseName && courseTitleSuggestions.length > 0">
            <div class="title-cards-grid">
              <div
                *ngFor="let titleCard of courseTitleSuggestions"
                class="title-card"
                [class.selected]="courseName === titleCard.title"
                (click)="selectTitleSuggestion(titleCard)">
                <div class="title-card-header">
                  <h3 class="title-card-title">{{ titleCard.title }}</h3>
                  <div class="title-card-info" *ngIf="titleCard.rationale" title="{{ titleCard.rationale }}">
                    <span class="info-icon">ℹ️</span>
                  </div>
                </div>
                <p class="title-card-rationale" *ngIf="titleCard.rationale">{{ titleCard.rationale }}</p>
              </div>
            </div>
          </div>
          
          <div class="loading-suggestions" *ngIf="loadingTitles">
            {{ currentLang === 'ar' ? 'جاري تحميل الاقتراحات...' : 'Loading suggestions...' }}
          </div>

          <!-- Topic Selection -->
          <!-- Show topic field only if AI was not used (manual course name entry) -->
          <div class="field-group" *ngIf="courseName && courseTitleSuggestions.length === 0">
            <label class="field-label" *ngIf="!selectedTopic">
              {{ currentLang === 'ar' ? 'الوحدة' : 'Topic' }}
              <span class="required">*</span>
            </label>

            <!-- Stored Topic (one line with underline) - only show when locked (after Continue) -->
            <div class="inline-field-display" *ngIf="selectedTopic && step2Locked" [dir]="isRTL ? 'rtl' : 'ltr'">
              <span class="inline-label">{{ currentLang === 'ar' ? 'الوحدة:' : 'Topic:' }}</span>
              <span class="inline-value underlined">{{ selectedTopic }}</span>
            </div>

            <!-- Manual Topic Input (shown when no AI was used) -->
            <div class="topics-section" *ngIf="courseName && !step2Locked && !selectedTopic">
              <div class="topic-input-wrapper">
                <input
                  type="text"
                  class="topic-input-manual"
                  [(ngModel)]="subjectSlug"
                  (input)="onSubjectSlugChange()"
                  [placeholder]="currentLang === 'ar' ? 'أدخل الوحدة...' : 'Enter topic...'"
                  maxlength="100" />
              </div>
              <div class="field-help">
                {{ currentLang === 'ar' ? 'اكتب اسم الوحدة يدوياً' : 'Enter the topic name manually' }}
              </div>
            </div>
          </div>

          <!-- Topic Selection Cards (shown when AI title card is selected) -->
          <div class="field-group" *ngIf="courseName && courseTitleSuggestions.length > 0 && availableTopics.length > 0">
            <label class="field-label" *ngIf="!selectedTopic">
              {{ currentLang === 'ar' ? 'الوحدة' : 'Topic' }}
              <span class="required">*</span>
            </label>

            <!-- Stored Topic (one line with underline) - only show when locked (after Continue) -->
            <div class="inline-field-display" *ngIf="selectedTopic && step2Locked" [dir]="isRTL ? 'rtl' : 'ltr'">
              <span class="inline-label">{{ currentLang === 'ar' ? 'الوحدة:' : 'Topic:' }}</span>
              <span class="inline-value underlined">{{ selectedTopic }}</span>
            </div>

            <!-- Topic Selection Cards (shown until Continue is clicked) -->
            <div class="topics-section" *ngIf="courseName && !step2Locked && availableTopics.length > 0">
              <div class="topics-grid">
                <div
                  *ngFor="let topic of availableTopics; let i = index"
                  class="topic-card"
                  [class.selected]="selectedTopic === topic && editingTopic !== topic"
                  [class.editing]="editingTopic === topic"
                  (click)="selectTopic(topic)">
                  <ng-container *ngIf="editingTopic === topic; else topicDisplay">
                    <input
                      type="text"
                      class="topic-input"
                      [(ngModel)]="editingTopicValue"
                      (click)="$event.stopPropagation()"
                      (keyup.enter)="saveTopicEdit()"
                      (keyup.escape)="cancelTopicEdit()"
                      [placeholder]="currentLang === 'ar' ? 'أدخل الوحدة...' : 'Enter topic...'"
                      (blur)="saveTopicEdit()" />
                  </ng-container>
                  <ng-template #topicDisplay>
                    <div class="topic-content">
                      <span class="topic-text">{{ topic }}</span>
                    </div>
                  </ng-template>
                </div>
              </div>
              <div class="field-help">
                {{ currentLang === 'ar' ? 'اختر وحدة واحدة أو انقر للتعديل' : 'Select one topic or click to edit' }}
              </div>
            </div>
          </div>

          <!-- Fallback Topic Input (if no topics from title card) -->
          <div class="field-group" *ngIf="courseName && availableTopics.length === 0 && !selectedTopic && !editingTopic">
            <label class="field-label">
              {{ currentLang === 'ar' ? 'الوحدة' : 'Topic' }}
              <span class="required">*</span>
            </label>
            <ng-select
              [(ngModel)]="subjectSlug"
              (change)="onSubjectSlugChange()"
              [items]="subjectSlugSuggestions"
              [searchable]="true"
              [clearable]="false"
              [placeholder]="currentLang === 'ar' ? 'اختر أو ابحث عن وحدة...' : 'Select or search for topic...'">
            </ng-select>
            <div class="field-help">
              {{ currentLang === 'ar' ? 'مثال: physics, algebra, programming' : 'Example: physics, algebra, programming' }}
            </div>
          </div>
      </div>
    </div>

    <!-- Action Buttons -->
    <div class="wizard-actions">
      <button 
        class="btn-back"
        *ngIf="currentStep === 2 || step2Locked"
        (click)="goBack()"
        [dir]="isRTL ? 'rtl' : 'ltr'">
        <span class="btn-icon">{{ isRTL ? '→' : '←' }}</span>
        <span>{{ currentLang === 'ar' ? 'رجوع' : 'Back' }}</span>
      </button>
      
      <button 
        class="btn-continue" 
        [disabled]="!canContinue"
        *ngIf="step2Locked"
        (click)="continue()">
        <span class="btn-icon">🤖</span>
        <span>{{ currentLang === 'ar' ? 'متابعة' : 'Continue' }}</span>
      </button>
      
      <button 
        class="btn-continue" 
        [disabled]="!canContinue || step2Locked"
        *ngIf="!step2Locked"
        (click)="continue()">
        <span class="btn-icon">🤖</span>
        <span>{{ currentLang === 'ar' ? 'متابعة' : 'Continue' }}</span>
      </button>
    </div>

    <!-- Warning Modal -->
    <div class="modal-overlay" *ngIf="showWarningModal" (click)="cancelGoBack()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ currentLang === 'ar' ? '⚠️ تحذير' : '⚠️ Warning' }}</h3>
        </div>
        <div class="modal-body">
          <p>{{ currentLang === 'ar' 
            ? 'سيتم حذف جميع البيانات المدخلة. هل أنت متأكد أنك تريد العودة؟ ستحتاج إلى البدء من جديد.' 
            : 'All entered data will be deleted. Are you sure you want to go back? You will need to start from scratch.' }}</p>
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" (click)="cancelGoBack()">
            {{ currentLang === 'ar' ? 'إلغاء' : 'Cancel' }}
          </button>
          <button class="btn-confirm" (click)="confirmGoBack()">
            {{ currentLang === 'ar' ? 'تأكيد' : 'Confirm' }}
          </button>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Info Preview -->
  <div class="info-preview" *ngIf="selectedCategory">
    <h3>{{ currentLang === 'ar' ? 'خطوات بناء المقرر:' : 'Course Building Steps:' }}</h3>
    <div class="preview-grid">
      <div class="preview-item">
        <span class="preview-icon">✅</span>
        <span class="preview-title">{{ currentLang === 'ar' ? 'الخطوة 1: التصنيف' : 'Step 1: Category' }}</span>
        <span class="preview-desc">{{ currentLang === 'ar' ? 'اختيار التصنيف الرئيسي (مكتمل)' : 'Pick main category (completed)' }}</span>
      </div>
      <div class="preview-item">
        <span class="preview-icon">📝</span>
        <span class="preview-title">{{ currentLang === 'ar' ? 'الخطوة 2: أساسيات المقرر' : 'Step 2: Course Basics' }}</span>
        <span class="preview-desc">{{ currentLang === 'ar' ? 'اسم المقرر والوحدة' : 'Name and topic' }}</span>
      </div>
      <div class="preview-item">
        <span class="preview-icon">🎯</span>
        <span class="preview-title">{{ currentLang === 'ar' ? 'الخطوة 3: بناء الوحدة الأولى' : 'Step 3: Build First Unit' }}</span>
        <span class="preview-desc">{{ currentLang === 'ar' ? 'أهداف، محتوى مختصر، واختبار من 3 أسئلة' : 'Objectives, brief content, and 3-question quiz' }}</span>
      </div>
      <div class="preview-item">
        <span class="preview-icon">🚀</span>
        <span class="preview-title">{{ currentLang === 'ar' ? 'الخطوة 4: مراجعة ونشر' : 'Step 4: Review & Publish' }}</span>
        <span class="preview-desc">{{ currentLang === 'ar' ? 'تحديد الرؤية والنشر مع قسم اختياري' : 'Set visibility and publish with optional section' }}</span>
      </div>
    </div>
  </div>
</div>

