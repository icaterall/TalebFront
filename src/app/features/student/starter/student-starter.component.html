<div class="starter-page" [dir]="isRTL ? 'rtl' : 'ltr'">
  
  <!-- Vibrant Hero Header with Gradient -->
  <div class="hero-header">
    <div class="decorative-shapes">
      <div class="shape-pattern"></div>
      <div class="shape-circle-1"></div>
      <div class="shape-circle-2"></div>
    </div>
    
    <div class="hero-content">
      <div class="badge-group">
        <span class="badge">ğŸ“ {{ stageName }}</span>
        <span class="badge">ğŸŒ {{ countryName }}</span>
      </div>
      <h1>{{ currentLang === 'ar' ? 'âœ¨ Ø£Ù†Ø´Ø¦ Ø¯Ø±Ø³Ùƒ Ù…Ø¹ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'âœ¨ Create Your Course with AI' }}</h1>
      <p class="hero-subtitle">
        {{ currentLang === 'ar' 
          ? 'Ø§Ø®ØªØ± Ù…ÙˆØ¶ÙˆØ¹Ù‹Ø§ ÙˆØ§Ø­Ø¯Ù‹Ø§ ÙˆØ³ÙŠØ³Ø§Ø¹Ø¯Ùƒ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ ÙÙŠ Ø¨Ù†Ø§Ø¡ Ø¯Ø±Ø³ Ø§Ø­ØªØ±Ø§ÙÙŠ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©.'
          : 'Pick one topic and AI will help you build a professional course step by step.' }}
      </p>
    </div>
  </div>

  <!-- Wizard Card Overlapping Hero -->
  <div class="wizard-card">
    <div class="wizard-card-inner">
    <!-- Wizard Progress -->
    <div class="wizard-progress">
      <div class="progress-step" [ngClass]="{'completed': step2Locked || currentStep > 1, 'current': currentStep === 1 && !step2Locked}">
        <div class="step-circle">
          <ng-container *ngIf="step2Locked || currentStep > 1; else stepOne">
            <span class="check-icon">âœ”</span>
          </ng-container>
          <ng-template #stepOne>1</ng-template>
        </div>
        <div class="step-labels">
          <span class="step-name">{{ currentLang === 'ar' ? 'Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©' : 'Course Basics' }}</span>
        </div>
      </div>
      <div class="progress-step" [ngClass]="{'completed': currentStep > 2, 'current': currentStep === 2, 'pending': currentStep < 2}">
        <div class="step-circle">
          <ng-container *ngIf="currentStep > 2; else stepTwo">
            <span class="check-icon">âœ”</span>
          </ng-container>
          <ng-template #stepTwo>2</ng-template>
        </div>
        <div class="step-labels">
          <span class="step-name">{{ currentLang === 'ar' ? 'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ù…' : 'Building Sections' }}</span>
        </div>
      </div>
      <div class="progress-step pending">
        <div class="step-circle">3</div>
        <div class="step-labels">
          <span class="step-name">{{ currentLang === 'ar' ? 'Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆÙ†Ø´Ø±' : 'Review & Publish' }}</span>
        </div>
      </div>
    </div>

    <!-- Wizard Body -->
    <div class="wizard-body">
      <!-- Step 1: Category Selection -->
      <div *ngIf="showStep1" class="step-content step1-content">
        <!-- Read-only Summary (shown when step2Locked is true) -->
        <div class="read-only-summary" *ngIf="step2Locked && selectedCategory" [dir]="isRTL ? 'rtl' : 'ltr'">
          <div class="summary-main">
            <div class="summary-item summary-item-with-action">
              <div class="summary-content">
                <span class="summary-label">{{ currentLang === 'ar' ? 'Ø§Ù„ØªØµÙ†ÙŠÙ:' : 'Category:' }}</span>
                <span class="summary-icon">{{ selectedCategory.icon }}</span>
                <span class="summary-value">{{ getCategoryName(selectedCategory) }}</span>
              </div>
              <button 
                type="button" 
                class="btn-start-from-scratch"
                (click)="showStartFromScratchModal = true"
                [attr.aria-label]="currentLang === 'ar' ? 'Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯' : 'Start from Scratch'">
                <span class="btn-icon">ğŸ”„</span>
                <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯' : 'Start from Scratch' }}</span>
              </button>
            </div>
            <div class="summary-item">
              <span class="summary-label">{{ currentLang === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:' : 'Course Name:' }}</span>
              <span class="summary-value">
                <span *ngIf="!editingCourseName && !savingCourseName">{{ courseName }}</span>
                <span *ngIf="savingCourseName" class="saving-indicator">
                  <span class="saving-spinner"></span>
                  <span class="saving-text">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'Saving...' }}</span>
                </span>
                <input 
                  *ngIf="editingCourseName && !savingCourseName"
                  type="text"
                  class="inline-edit-input"
                  [(ngModel)]="editingCourseNameValue"
                  (keyup.enter)="saveCourseNameEdit()"
                  (keyup.escape)="cancelCourseNameEdit()"
                  [placeholder]="currentLang === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©' : 'Course Name'"
                  [dir]="isRTL ? 'rtl' : 'ltr'"
                  maxlength="200">
                <div class="summary-action-buttons">
                  <button *ngIf="!editingCourseName && !savingCourseName" type="button" class="summary-edit-btn" (click)="startEditingCourseName()" [attr.aria-label]="currentLang === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©' : 'Edit Course Name'">âœï¸</button>
                  <div *ngIf="editingCourseName && !savingCourseName" class="inline-edit-actions">
                    <button type="button" class="inline-edit-btn inline-edit-cancel" (click)="cancelCourseNameEdit()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel'">âœ•</button>
                    <button type="button" class="inline-edit-btn inline-edit-save" (click)="saveCourseNameEdit()" [attr.aria-label]="currentLang === 'ar' ? 'Ø­ÙØ¸' : 'Save'">âœ“</button>
                  </div>
                </div>
              </span>
            </div>
          </div>
          <app-cover-image
            [courseCoverPreview]="courseCoverPreview"
            [defaultCourseCover]="defaultCourseCover"
            [courseCoverUploading]="courseCoverUploading"
            [courseCoverDeleting]="courseCoverDeleting"
            [courseCoverUploadProgress]="courseCoverUploadProgress"
            [courseCoverUploadError]="courseCoverUploadError"
            [hasCustomCourseCover]="hasCustomCourseCover"
            [coverImageLoaded]="coverImageLoaded"
            [currentLang]="currentLang"
            (select)="onCourseCoverSelected($event)"
            (openDelete)="showDeleteCoverModal = true"
            (confirmDelete)="confirmDeleteCover()"
            (imageLoad)="onCoverImageLoad()"
            (imageError)="onCoverImageError()">
          </app-cover-image>
        </div>

        <!-- Empty State: Show Add Section Button when no sections exist -->
        <div class="sections-empty-state" *ngIf="step2Locked && selectedCategory && sections.length === 0" [dir]="isRTL ? 'rtl' : 'ltr'">
          <div class="empty-state-content">
            <div class="empty-state-icon">ğŸ“š</div>
            <h3 class="empty-state-title">{{ currentLang === 'ar' ? 'Ø§Ø¨Ø¯Ø£ Ø¨Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯' : 'Start by adding a new section' }}</h3>
            <p class="empty-state-description">
              {{ currentLang === 'ar' 
                ? 'ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… ÙŠØ¯ÙˆÙŠØ§Ù‹ Ø£Ùˆ Ø±ÙØ¹ Ù…Ù„Ù Word/PDF/PPT Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹' 
                : 'You can add a section manually or upload a Word/PDF/PPT file to generate content automatically' }}
            </p>
            <button
              type="button"
              class="btn-add-section-empty"
              (click)="openAddSectionModal()"
              [attr.aria-label]="currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯' : 'Add new section'">
              <span class="btn-icon">â•</span>
              <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯' : 'Add New Section' }}</span>
            </button>
          </div>
        </div>

        <!-- Sections List (Multiple Sections Support) -->
        <div class="sections-list" *ngIf="step2Locked && selectedCategory && sections.length > 0" [dir]="isRTL ? 'rtl' : 'ltr'">
          <!-- Loop through sections -->
          <div 
            *ngFor="let section of sections; let i = index; trackBy: trackBySectionId"
            class="section-wrapper"
            [class.collapsed]="section.isCollapsed"
            [attr.data-section-id]="section.id">
            
            <!-- Section Header -->
            <div 
              class="section-content-header"
              [attr.data-section-id]="section.id"
              tabindex="0"
              (click)="toggleSectionFold(section.id)"
              (keydown.enter)="toggleSectionFold(section.id)">
              
              <div class="section-header-main">
                <button 
                  type="button"
                  class="section-fold-btn"
                  [class.collapsed]="section.isCollapsed"
                  [attr.aria-label]="section.isCollapsed ? (currentLang === 'ar' ? 'ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù‚Ø³Ù…' : 'Expand section') : (currentLang === 'ar' ? 'Ø·ÙŠ Ø§Ù„Ù‚Ø³Ù…' : 'Collapse section')">
                  <span class="fold-icon">{{ section.isCollapsed ? 'â–¶' : 'â–¼' }}</span>
                </button>

                <div class="section-order-controls">
                  <button
                    type="button"
                    class="section-order-btn"
                    (click)="$event.stopPropagation(); moveSectionUp(section.id)"
                    [disabled]="i === 0 || isReorderingSection(section.id)"
                    [attr.aria-busy]="isReorderingSection(section.id) ? 'true' : null"
                    [attr.aria-label]="currentLang === 'ar' ? 'ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø¹Ù„Ù‰' : 'Move up'">
                    <span class="order-icon" *ngIf="!isReorderingSection(section.id)">â¬†ï¸</span>
                    <span class="order-loading" *ngIf="isReorderingSection(section.id)">â³</span>
                  </button>
                  <button
                    type="button"
                    class="section-order-btn"
                    (click)="$event.stopPropagation(); moveSectionDown(section.id)"
                    [disabled]="i === sections.length - 1 || isReorderingSection(section.id)"
                    [attr.aria-busy]="isReorderingSection(section.id) ? 'true' : null"
                    [attr.aria-label]="currentLang === 'ar' ? 'ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø³ÙÙ„' : 'Move down'">
                    <span class="order-icon" *ngIf="!isReorderingSection(section.id)">â¬‡ï¸</span>
                    <span class="order-loading" *ngIf="isReorderingSection(section.id)">â³</span>
                  </button>
                </div>

                <div class="section-header-info">
                  <div class="section-title-row">
                    <ng-container *ngIf="editingSection && editingSectionId === section.id; else sectionTitleDisplay">
                      <div class="section-name-edit-wrapper">
                        <input
                          type="text"
                          class="section-name-edit-input"
                          [(ngModel)]="editingSectionValue"
                          (click)="$event.stopPropagation()"
                          (keyup.enter)="saveSectionEdit()"
                          (keyup.escape)="cancelSectionEdit()"
                          [placeholder]="currentLang === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…' : 'Section name'"
                          [dir]="isRTL ? 'rtl' : 'ltr'"
                          maxlength="200"
                          autofocus>
                        <div class="section-name-input-actions">
                          <button
                            type="button"
                            class="section-name-save-btn"
                            (click)="$event.stopPropagation(); saveSectionEdit()"
                            [disabled]="sectionSaving || !editingSectionValue || !editingSectionValue.trim()"
                            [attr.aria-label]="currentLang === 'ar' ? 'Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…' : 'Save section name'">
                            <ng-container *ngIf="!sectionSaving">âœ“</ng-container>
                            <span *ngIf="sectionSaving" class="btn-spinner" aria-hidden="true"></span>
                          </button>
                          <button
                            *ngIf="section.name && section.name.trim()"
                            type="button"
                            class="section-name-cancel-btn"
                            (click)="$event.stopPropagation(); cancelSectionEdit()"
                            [attr.aria-label]="currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel'">
                            âœ•
                          </button>
                        </div>
                      </div>
                    </ng-container>
                    <ng-template #sectionTitleDisplay>
                      <h3 class="section-name"
                          (click)="$event.stopPropagation(); renameSection(section.id)">
                        <span class="section-number">{{ currentLang === 'ar' ? 'Ø§Ù„Ù‚Ø³Ù…' : 'Section' }} {{ section.number }}</span>
                        <span class="section-title">{{ section.name }}</span>
                      </h3>
                    </ng-template>

                    <div class="section-title-actions">
                      <button
                        type="button"
                        class="section-icon-btn"
                        (click)="$event.stopPropagation(); renameSection(section.id)"
                        [attr.aria-label]="currentLang === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù‚Ø³Ù…' : 'Edit section'">
                        âœï¸
                      </button>
                      <button
                        type="button"
                        class="section-icon-btn section-delete-btn"
                        (click)="$event.stopPropagation(); deleteSection(section.id)"
                        [attr.aria-label]="currentLang === 'ar' ? 'Ø­Ø°Ù Ø§Ù„Ù‚Ø³Ù…' : 'Delete section'">
                        ğŸ—‘ï¸
                      </button>
                      <button
                        type="button"
                        class="section-toggle-switch"
                        (click)="toggleSectionAvailability(section.id, $event)"
                        role="switch"
                        [attr.aria-checked]="section.available !== false"
                        [attr.aria-label]="section.available !== false ? (currentLang === 'ar' ? 'Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù‚Ø³Ù…' : 'Hide section') : (currentLang === 'ar' ? 'Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø³Ù…' : 'Show section')"
                        [class.active]="section.available !== false">
                        <span class="switch-track">
                          <span class="switch-handle"></span>
                        </span>
                      
                      </button>
                    </div>
                  </div>

                  <div class="section-meta">
                    <span class="section-item-count">
                      {{ getItemCountDisplay(section.content_items?.length || 0) }}
                    </span>
                    <span class="section-visibility" [class.hidden]="section.available === false">
                      {{ section.available !== false ? (currentLang === 'ar' ? 'Ù…ØªØ§Ø­' : 'Visible') : (currentLang === 'ar' ? 'Ù…Ø®ÙÙŠ' : 'Hidden') }}
                    </span>
                    <span class="section-created-at" *ngIf="section.createdAt">
                      {{ formatContentDate(section.createdAt) }}
                    </span>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Section Content (collapsible) -->
            <div class="section-content-body" *ngIf="!section.isCollapsed">
              <!-- Content Items List -->
              <div class="content-items-list" *ngIf="section.content_items && section.content_items.length > 0">
                <div 
                  *ngFor="let item of section.content_items; let j = index; trackBy: trackByContentId"
                  class="content-item-card"
                  [class.content-type-text]="item.type === 'text'"
                  [class.content-type-resources]="item.type === 'resources'"
                  [class.content-type-video]="item.type === 'video'"
                  [class.content-type-audio]="item.type === 'audio'"
                  [class.content-type-quiz]="item.type === 'quiz'"
                  (click)="openContentItem(item)"
                  [style.cursor]="(item.type === 'video' || item.type === 'audio' || item.type === 'resources' || item.type === 'quiz') ? 'pointer' : 'default'">
                  
                  <div class="content-item-header">
                    <div class="content-item-main">
                      <div class="content-order-inline">
                        <button 
                          type="button" 
                          class="order-btn" 
                          (click)="moveContentItemUp(j, section.id)"
                          [disabled]="isReordering(item.id) || j === 0"
                          [attr.aria-busy]="isReordering(item.id) ? 'true' : null"
                          [attr.aria-label]="currentLang === 'ar' ? 'ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø¹Ù„Ù‰' : 'Move up'">
                          â¬†ï¸
                        </button>
                        <button 
                          type="button" 
                          class="order-btn" 
                          (click)="moveContentItemDown(j, section.id)"
                          [disabled]="isReordering(item.id) || j === section.content_items.length - 1"
                          [attr.aria-busy]="isReordering(item.id) ? 'true' : null"
                          [attr.aria-label]="currentLang === 'ar' ? 'ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø³ÙÙ„' : 'Move down'">
                          â¬‡ï¸
                        </button>
                        <span class="order-loading" *ngIf="isReordering(item.id)">â³</span>
                      </div>
                      <div class="content-item-type-icon">
                        <span *ngIf="item.type === 'text'">ğŸ“</span>
                        <span *ngIf="item.type === 'resources'">ğŸ“„</span>
                        <span *ngIf="item.type === 'video'">ğŸ¥</span>
                        <span *ngIf="item.type === 'audio'">ğŸ§</span>
                        <span *ngIf="item.type === 'quiz'">ğŸ“‹</span>
                      </div>
                      <div class="content-item-text" (click)="viewContentItem(item)">
                        <h4 class="content-item-title">{{ item.title }}</h4>
                        <div class="content-item-preview" *ngIf="item.type === 'text' && item.content">
                          <p class="content-text-preview">
                            {{ getTextPreview(item.content) }}
                          </p>
                        </div>
                        <div class="content-item-preview" *ngIf="item.type === 'resources' && item.resourceDetails">
                          <ng-container *ngFor="let entry of getResourceDetailEntries(item.resourceDetails); let last = last">
                            <span class="content-detail"><strong>{{ entry.label }}:</strong> {{ entry.value }}</span><span *ngIf="!last">{{ getResourceDetailSeparator() }}</span>
                          </ng-container>
                        </div>
                        <div class="content-item-preview" *ngIf="item.type === 'video' && item.meta">
                          <ng-container *ngFor="let entry of getVideoDetailEntries(item); let last = last">
                            <span class="content-detail"><strong>{{ entry.label }}:</strong> {{ entry.value }}</span><span *ngIf="!last">{{ getResourceDetailSeparator() }}</span>
                          </ng-container>
                        </div>
                        <div class="content-item-preview" *ngIf="item.type === 'audio' && item.meta">
                          <!-- Audio Player -->
                          <div class="content-audio-player" *ngIf="item.meta['dataUrl']">
                            <audio 
                              [src]="item.meta['dataUrl']"
                              controls
                              preload="metadata"
                              class="mini-audio-player"
                              (click)="$event.stopPropagation()">
                            </audio>
                          </div>
                          <!-- Audio Details -->
                          <div class="content-audio-details">
                            <ng-container *ngFor="let entry of getAudioDetailEntries(item); let last = last">
                              <span class="content-detail"><strong>{{ entry.label }}:</strong> {{ entry.value }}</span><span *ngIf="!last">{{ getResourceDetailSeparator() }}</span>
                            </ng-container>
                          </div>
                        </div>
                        <div class="content-item-preview" *ngIf="item.type === 'quiz' && item.meta">
                          <ng-container *ngIf="getQuizInfo(item) as quizInfo">
                            <span class="content-detail" *ngIf="quizInfo.questionCount > 0">
                              <strong>{{ currentLang === 'ar' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©' : 'Questions' }}:</strong> {{ quizInfo.questionCount }}
                            </span>
                            <span class="content-detail" *ngIf="quizInfo.fullScore > 0">
                              <strong>{{ currentLang === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ' : 'Total Score' }}:</strong> {{ quizInfo.fullScore }}
                            </span>
                            <span class="content-detail" *ngIf="quizInfo.questionCount > 0 && quizInfo.pointsPerQuestion > 0">
                              <strong>{{ currentLang === 'ar' ? 'Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„' : 'Points per Question' }}:</strong> {{ quizInfo.pointsPerQuestion }}
                            </span>
                          </ng-container>
                        </div>
                      </div>
                    </div>

                    <div class="content-item-header-actions">
                      <div class="content-action-icons">
                        <button
                          type="button"
                          class="content-toggle-switch"
                          (click)="$event.stopPropagation(); toggleContentStatus(section.id, item.id, $event)"
                          role="switch"
                          [attr.aria-checked]="isContentStatusActive(item)"
                          [attr.aria-label]="isContentStatusActive(item) ? (currentLang === 'ar' ? 'Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'Deactivate content') : (currentLang === 'ar' ? 'ØªÙ†Ø´ÙŠØ· Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'Activate content')"
                          [class.active]="isContentStatusActive(item)"
                          [disabled]="isContentStatusWaiting(item)">
                          <span class="switch-track">
                            <span class="switch-handle"></span>
                          </span>
                        </button>
 
                         <span class="status-inline" *ngIf="isContentStatusWaiting(item)">
                           â³
                         </span>

                        <button
                          type="button"
                          class="content-icon-btn delete"
                          (click)="$event.stopPropagation(); deleteContentItem(item.id)"
                          [attr.aria-label]="currentLang === 'ar' ? 'Ø­Ø°Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'Delete content'">
                          ğŸ—‘ï¸
                        </button>
                      </div>
                      <div class="content-item-meta" *ngIf="item.createdAt || item.status !== undefined && item.status !== null">
                        <span class="content-item-date" *ngIf="item.createdAt">
                          {{ formatContentDate(item.createdAt) }}
                        </span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- Add Content Buttons -->
              <div class="add-content-actions">
                <button type="button" class="add-content-btn" (click)="setActiveSection(section.id); openContentTypeModal('text')" [disabled]="!section.name || !section.name.trim()">
                  <span class="btn-icon">ğŸ“</span>
                  <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø¯Ø±Ø³ Ù†ØµÙŠ' : 'Add Text Lesson' }}</span>
                </button>
                <button type="button" class="add-content-btn" (click)="setActiveSection(section.id); openContentTypeModal('resources')" [disabled]="!section.name || !section.name.trim()">
                  <span class="btn-icon">ğŸ“„</span>
                  <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù…Ù„ÙØ§Øª' : 'Add Resources' }}</span>
                </button>
                <button type="button" class="add-content-btn" (click)="setActiveSection(section.id); openContentTypeModal('video')" [disabled]="!section.name || !section.name.trim()">
                  <span class="btn-icon">ğŸ¥</span>
                  <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ' : 'Add Video' }}</span>
                </button>
                <button type="button" class="add-content-btn" (click)="setActiveSection(section.id); openContentTypeModal('audio')" [disabled]="!section.name || !section.name.trim()">
                  <span class="btn-icon">ğŸ§</span>
                  <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© ØµÙˆØª' : 'Add Audio' }}</span>
                </button>
                <button type="button" class="add-content-btn" (click)="setActiveSection(section.id); openContentTypeModal('quiz')" [disabled]="!section.name || !section.name.trim()">
                  <span class="btn-icon">ğŸ“‹</span>
                  <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±' : 'Create Quiz' }}</span>
                </button>
              </div>
            </div>
          </div>

          <!-- Add New Section Button (Full-width ghost button under last section) -->
          <button
            type="button"
            class="btn-add-section"
            (click)="openAddSectionModal()"
            [disabled]="hasUnnamedSection()"
            [attr.aria-label]="currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯' : 'Add new section'">
            <span class="btn-icon">â•</span>
            <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯' : 'Add New Section' }}</span>
          </button>
        </div>

        <!-- Skeleton Loader for Read-only Summary (shown when loading or data is being fetched) -->
        <div class="read-only-summary read-only-summary-skeleton" *ngIf="showSummarySkeleton" [dir]="isRTL ? 'rtl' : 'ltr'">
          <div class="summary-item summary-item-with-action">
            <div class="summary-content">
              <span class="summary-label skeleton-text"></span>
              <span class="summary-icon skeleton-icon"></span>
              <span class="summary-value skeleton-text"></span>
            </div>
            <div class="btn-start-from-scratch skeleton-button"></div>
          </div>
          <div class="summary-item">
            <span class="summary-label skeleton-text"></span>
            <span class="summary-value skeleton-text"></span>
          </div>
        </div>

        <!-- Selected Category Display (Box style with Change button - shown in Step 1) -->
        <div class="selected-display" *ngIf="selectedCategory && !step2Locked">
          <div class="selected-badge">
            <span class="selected-icon">{{ selectedCategory.icon }}</span>
            <div class="selected-info">
              <span class="selected-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø§Ù„Ù…Ø®ØªØ§Ø±' : 'Selected Category' }}</span>
              <span class="selected-name">{{ getCategoryName(selectedCategory) }}</span>
            </div>
            <button class="change-btn" (click)="clearCategorySelection()">
              {{ currentLang === 'ar' ? 'ØªØºÙŠÙŠØ±' : 'Change' }}
            </button>
          </div>
        </div>

        <!-- Course Title Section (Shows after category selection) -->
        <div class="course-title-section" *ngIf="selectedCategory && !step2Locked">
          <!-- Course Name Input -->
          <div class="field-group course-name-input-group" *ngIf="!step2Locked">
            <label class="field-label">
              {{ currentLang === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©' : 'Course Name' }}
              <span class="required">*</span>
            </label>
            <div class="course-name-input-row">
              <input
                type="text"
                class="course-name-input"
                [(ngModel)]="courseName"
                (input)="onCourseNameChange()"
                [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©...' : 'Enter course name...'"
                maxlength="80" />
            </div>
            <div class="field-help">
              {{ currentLang === 'ar' ? 'Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙŠØ¯ÙˆÙŠØ§Ù‹' : 'Type the course name manually' }}
            </div>
          </div>



        </div>

        <!-- Category Selection (hidden when step2Locked) -->
        <app-category-selector
          *ngIf="!selectedCategory && !step2Locked"
          [smartSix]="smartSix"
          [allCategories]="allCategories"
          [(selectedCategoryId)]="selectedCategoryId"
          (selectedCategoryIdChange)="onNgSelectChange()"
          [loading]="loading"
          [currentLang]="currentLang"
          [isRTL]="isRTL"
          (categorySelected)="selectCategory($event)">
        </app-category-selector>
      </div>

      <!-- Step 2: Course Basics -->
      <div *ngIf="showStep2" class="step-content step2-content">
        <!-- Header with Change Category Link -->
        <div class="step2-header">
          <button class="change-category-link" (click)="goBack()" *ngIf="selectedCategory">
            <span class="link-icon">â†</span>
            {{ currentLang === 'ar' ? 'ØªØºÙŠÙŠØ± Ø§Ù„ØªØµÙ†ÙŠÙ' : 'Change Category' }}
          </button>
        </div>

        <!-- Category Info - Always show if category is selected -->
        <div class="category-info-wrapper" *ngIf="selectedCategory">
          <div class="field-group category-display-group">
            <div class="inline-field-display" [dir]="isRTL ? 'rtl' : 'ltr'">
              <span class="inline-label">{{ currentLang === 'ar' ? 'Ø§Ù„ØªØµÙ†ÙŠÙ:' : 'Category:' }}</span>
              <span class="inline-icon">{{ selectedCategory.icon }}</span>
              <span class="inline-value">{{ getCategoryName(selectedCategory) }}</span>
            </div>
          </div>
        </div>

        <!-- A) Course Name -->
        <div class="field-group">
          <label class="field-label" *ngIf="!courseName">
            {{ currentLang === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©' : 'Course Name' }}
            <span class="required">*</span>
          </label>

          <!-- Stored Course Name (one line with underline) -->
          <div class="inline-field-display" *ngIf="courseName" [dir]="isRTL ? 'rtl' : 'ltr'">
            <span class="inline-label">{{ currentLang === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:' : 'Course Name:' }}</span>
            <span class="inline-value underlined">{{ courseName }}</span>
          </div>

          <!-- AI Title Suggestions (Cards) -->
          <div class="title-cards-container" *ngIf="!courseName && courseTitleSuggestions.length > 0">
            <div class="title-cards-grid">
              <div
                *ngFor="let titleCard of courseTitleSuggestions"
                class="title-card"
                [class.selected]="courseName === titleCard.title"
                (click)="selectTitleSuggestion(titleCard)">
                <div class="title-card-header">
                  <h3 class="title-card-title">{{ titleCard.title }}</h3>
                  <div class="title-card-info" *ngIf="titleCard.rationale" title="{{ titleCard.rationale }}">
                    <span class="info-icon">â„¹ï¸</span>
                  </div>
                </div>
                <p class="title-card-rationale" *ngIf="titleCard.rationale">{{ titleCard.rationale }}</p>
              </div>
            </div>
          </div>
          
          <div class="loading-suggestions" *ngIf="loadingTitles">
            {{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø§Ù‚ØªØ±Ø§Ø­Ø§Øª...' : 'Loading suggestions...' }}
          </div>

      </div>
    </div>

    <!-- Action Buttons -->
    <div class="wizard-actions" [dir]="isRTL ? 'rtl' : 'ltr'">

      
      <button 
        class="btn-continue" 
        [disabled]="!canContinue || savingDraftCourse"
        [attr.aria-busy]="savingDraftCourse"
        *ngIf="step2Locked"
        (click)="continue()">
        <span *ngIf="savingDraftCourse" class="btn-spinner" aria-hidden="true"></span>
        <span *ngIf="!savingDraftCourse" class="btn-icon">ğŸ¤–</span>
        <span>{{ currentLang === 'ar' ? 'Ù…ØªØ§Ø¨Ø¹Ø©' : 'Continue' }}</span>
      </button>
      
      <button 
        class="btn-continue" 
        [disabled]="!canContinue || step2Locked || savingDraftCourse"
        [attr.aria-busy]="savingDraftCourse"
        *ngIf="!step2Locked"
        (click)="continue()">
        <span *ngIf="savingDraftCourse" class="btn-spinner" aria-hidden="true"></span>
        <span *ngIf="!savingDraftCourse" class="btn-icon">ğŸ¤–</span>
        <span>{{ currentLang === 'ar' ? 'Ù…ØªØ§Ø¨Ø¹Ø©' : 'Continue' }}</span>
      </button>
    </div>

    <div class="continue-error" *ngIf="continueErrorMessage" role="alert" aria-live="assertive">
      {{ continueErrorMessage }}
    </div>

    <!-- Warning Modal -->
    <div class="modal-overlay warning-modal-overlay" *ngIf="showWarningModal" (click)="cancelGoBack()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ currentLang === 'ar' ? 'âš ï¸ ØªØ­Ø°ÙŠØ±' : 'âš ï¸ Warning' }}</h3>
        </div>
        <div class="modal-body">
          <p class="warning-modal-text" *ngIf="warningModalType === 'goBack'">{{ currentLang === 'ar' 
            ? 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¯Ø®Ù„Ø©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø§Ù„Ø¹ÙˆØ¯Ø©ØŸ Ø³ØªØ­ØªØ§Ø¬ Ø¥Ù„Ù‰ Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯.' 
            : 'All entered data will be deleted. Are you sure you want to go back? You will need to start from scratch.' }}</p>
          <p class="warning-modal-text" *ngIf="warningModalType === 'deleteContent'">{{ currentLang === 'ar' 
            ? 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.' 
            : 'Are you sure you want to delete this content? This action cannot be undone.' }}</p>
        </div>
        <div class="modal-actions">
          <button class="btn-cancel" (click)="cancelGoBack()">
            {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
          </button>
          <button
            class="btn-confirm"
            [disabled]="warningModalType === 'deleteContent' ? isDeletingContent : false"
            [attr.aria-busy]="warningModalType === 'deleteContent' && isDeletingContent ? 'true' : null"
            (click)="warningModalType === 'goBack' ? confirmGoBack() : confirmDeleteContent()"
          >
            <span *ngIf="warningModalType === 'deleteContent' && isDeletingContent" class="btn-spinner" aria-hidden="true"></span>
            <span>{{ currentLang === 'ar' ? 'ØªØ£ÙƒÙŠØ¯' : 'Confirm' }}</span>
          </button>
        </div>
      </div>
    </div>

    <!-- AI Hint Modal (shown above text editor modal) -->
    <div class="modal-overlay ai-hint-overlay" *ngIf="showAIHintModal" (click)="cancelAIHint()" style="z-index: 10001;">
      <div class="modal-content ai-hint-modal" (click)="$event.stopPropagation()" style="z-index: 10001;">
        <div class="modal-header">
          <h3>{{ currentLang === 'ar' ? 'ğŸ¤– ØªÙ„Ù…ÙŠØ­ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'ğŸ¤– AI Hint' }}</h3>
          <button type="button" class="modal-close-btn" (click)="cancelAIHint()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="hint-field">
            <label class="field-label">
              {{ viewingContentItem?.meta?.['hint'] 
                ? (currentLang === 'ar' ? 'ğŸ¤– ØªÙ„Ù…ÙŠØ­ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)' : 'ğŸ¤– AI-Generated Hint (You can modify)')
                : (currentLang === 'ar' ? 'Ø£Ø¶Ù ØªÙ„Ù…ÙŠØ­Ø§Ù‹ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'Add hint for AI') }}
            </label>
            <textarea 
              class="hint-input"
              [class.ai-generated]="viewingContentItem?.meta?.['hint']"
              [(ngModel)]="aiHint"
              [placeholder]="currentLang === 'ar' ? 'Ù…Ø«Ø§Ù„: Ø±ÙƒØ² Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ§ØªØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø£Ù…Ø«Ù„Ø© Ø¹Ù…Ù„ÙŠØ©ØŒ Ø§Ø¬Ø¹Ù„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ù…Ù†Ø§Ø³Ø¨Ø§Ù‹ Ù„Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†...' : 'Example: Focus on fundamentals, use practical examples, make content suitable for beginners...'"
              [dir]="isRTL ? 'rtl' : 'ltr'"
              rows="4"
              maxlength="250"></textarea>
            <div class="field-help">
              {{ viewingContentItem?.meta?.['hint']
                ? (currentLang === 'ar' ? 'Ù‡Ø°Ø§ Ø§Ù„ØªÙ„Ù…ÙŠØ­ ØªÙ… Ø¥Ù†Ø´Ø§Ø¤Ù‡ Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ (50 ÙƒÙ„Ù…Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰). ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¹Ø¯ÙŠÙ„Ù‡ Ø£Ùˆ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.' : 'This hint was AI-generated (max 50 words). You can modify it or add more details.')
                : (currentLang === 'ar' ? 'Ø§Ù„ØªÙ„Ù…ÙŠØ­ Ù…Ø·Ù„ÙˆØ¨ Ù„ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ù…Ù†Ø§Ø³Ø¨ (50 ÙƒÙ„Ù…Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰)' : 'Hint is required to guide AI for appropriate content generation (max 50 words)') }}
            </div>
          </div>
          
          <div class="hint-actions">
            <button type="button" class="btn-continue" 
              [disabled]="!aiHint || !aiHint.trim()"
              (click)="proceedWithAIGeneration(true)">
              {{ currentLang === 'ar' ? 'Ù…ØªØ§Ø¨Ø¹Ø©' : 'Continue' }}
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Text Editor Modal -->
    <div class="modal-overlay" *ngIf="showTextEditor">
      <div class="modal-content text-editor-modal">
        <div class="modal-header">
          <h3>{{ currentLang === 'ar' ? 'âœï¸ Ø¥Ù†Ø´Ø§Ø¡ Ø¯Ø±Ø³ Ù†ØµÙŠ' : 'âœï¸ Create Text Lesson' }}</h3>
          <button type="button" class="modal-close-btn" (click)="closeTextEditor()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="subsection-title-field">
            <label class="field-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù† *' : 'Title *' }}</label>
            <input 
              type="text" 
              class="subsection-title-input"
              [(ngModel)]="subsectionTitle"
              [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†...' : 'Enter title...'"
              [dir]="isRTL ? 'rtl' : 'ltr'"
              maxlength="200">
            <div class="field-help">{{ currentLang === 'ar' ? 'Ù…Ø«Ø§Ù„: Ù…Ù‚Ø¯Ù…Ø©ØŒ Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©ØŒ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ©' : 'Example: Introduction, Core Concepts, Practical Applications' }}</div>
          </div>
          
          <div class="editor-toolbar">
            <div class="ai-button-group">
              <button 
                type="button"
                class="btn-generate-ai"
                [disabled]="generatingWithAI || !subsectionTitle || !subsectionTitle.trim()"
                (click)="generateTextWithAI()">
                <span class="btn-icon">ğŸ¤–</span>
                <span class="btn-text">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'Generate Text with AI' }}</span>
                <span class="btn-hint">{{ currentLang === 'ar' ? '(Ø³ÙˆÙ ÙŠØ³ØªØºØ±Ù‚ Ø¯Ù‚ÙŠÙ‚Ø©)' : '(Will take a minute)' }}</span>
              </button>
              <div class="ai-generating-dhikr" *ngIf="generatingWithAI">
                <div class="dhikr-badge">
                  <div class="dhikr-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                  </div>
                  <span class="dhikr-icon">âœ¨</span>
                  <span class="dhikr-phrase">{{ currentDhikr }}</span>
                </div>
              </div>
            </div>
          </div>
          
          <div class="editor-container" [attr.dir]="isRTL ? 'rtl' : 'ltr'">
            <ckeditor 
              [editor]="Editor"
              [config]="editorConfig"
              [(ngModel)]="textContent"
              (ready)="onReady($event)">
            </ckeditor>
          </div>
          
          <div class="editor-actions">
            <button type="button" class="btn-cancel" (click)="cancelTextEditor()">
              {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
            </button>
            <button
              type="button"
              class="btn-save"
              [disabled]="generatingWithAI || !subsectionTitle.trim() || savingTextContent || isEditorUploading"
              (click)="saveTextContent()">
              <span *ngIf="!savingTextContent">{{ currentLang === 'ar' ? 'Ø­ÙØ¸' : 'Save' }}</span>
              <span *ngIf="savingTextContent" class="btn-save-content">
                <span class="inline-spinner" aria-hidden="true"></span>
                <span>{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...' : 'Saving...' }}</span>
              </span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Content Type Creation Modal (AI-assisted or Manual) -->
    <div class="modal-overlay" *ngIf="showContentTypeModal">
      <div class="modal-content content-type-modal" (click)="$event.stopPropagation()">
        <div class="modal-header">
          <h3>{{ getContentTypeModalTitle() }}</h3>
          <button type="button" class="modal-close-btn" (click)="closeContentTypeModal()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
        </div>
        <div class="modal-body">
          <p class="modal-description">{{ getContentTypeModalDescription() }}</p>
          <div class="creation-options">
            <button 
              type="button"
              class="creation-option-btn ai-option"
              (click)="selectCreationMode('ai')">
              <span class="option-icon">ğŸ¤–</span>
              <span class="option-label">{{ currentLang === 'ar' ? 'Ù…Ø³Ø§Ø¹Ø¯ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'AI-assisted' }}</span>
              <span class="option-desc">{{ currentLang === 'ar' ? 'Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹' : 'Use AI to automatically generate content' }}</span>
            </button>
            
            <button 
              type="button"
              class="creation-option-btn manual-option"
              (click)="selectCreationMode('manual')">
              <span class="option-icon">âœï¸</span>
              <span class="option-label">{{ currentLang === 'ar' ? 'ÙŠØ¯ÙˆÙŠ' : 'Manual' }}</span>
              <span class="option-desc">{{ currentLang === 'ar' ? 'Ù‚Ù… Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ù†ÙØ³Ùƒ Ø®Ø·ÙˆØ© Ø¨Ø®Ø·ÙˆØ©' : 'Create content yourself step by step' }}</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resource Creation Modal -->
    <div class="modal-overlay" *ngIf="showResourceModal">
      <div class="modal-content resource-modal" (click)="$event.stopPropagation()" [dir]="isRTL ? 'rtl' : 'ltr'">
        <div class="modal-header">
          <h3>{{ currentLang === 'ar' ? 'ğŸ“„ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù' : 'ğŸ“„ Add Resource' }}</h3>
          <button type="button" class="modal-close-btn" (click)="closeResourceModal()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
        </div>
        <div class="modal-body">
          <div class="field-group">
            <label class="field-label" for="resourceTitle">{{ currentLang === 'ar' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù…Ù„Ù *' : 'Resource Title *' }}</label>
            <input
              id="resourceTitle"
              type="text"
              class="field-input"
              [(ngModel)]="resourceForm.title"
              [placeholder]="currentLang === 'ar' ? 'Ù…Ø«Ø§Ù„: Ø£ÙˆØ±Ø§Ù‚ Ø¹Ù…Ù„ Ø§Ù„ÙˆØ­Ø¯Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰' : 'Example: Unit 1 Worksheets'"
              [dir]="isRTL ? 'rtl' : 'ltr'"
              maxlength="150" />
          </div>

          <div class="field-group">
            <label class="field-label" for="resourceType">{{ currentLang === 'ar' ? 'Ù†ÙˆØ¹ Ø§Ù„Ù…Ù„Ù' : 'File Type' }}</label>
            <select id="resourceType" class="field-select" [(ngModel)]="resourceForm.displayType">
              <option *ngFor="let option of resourceTypeOptions" [value]="option.value">
                {{ currentLang === 'ar' ? option.icon + ' ' + option.labelAr : option.icon + ' ' + option.labelEn }}
              </option>
            </select>
            <div class="field-help">{{ currentLang === 'ar' ? 'Ø§Ù„ØµÙŠØº Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡Ø§: ZIP, RAR, PDF, PPT/PPTXØŒ XLS/XLSXØŒ DOC/DOCX.' : 'Allowed formats: ZIP, RAR, PDF, PPT/PPTX, XLS/XLSX, DOC/DOCX.' }}</div>
          </div>

          <div class="field-group">
            <label class="field-label" for="resourceFile">{{ currentLang === 'ar' ? 'ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù *' : 'Upload File *' }}</label>
            <input id="resourceFile" type="file" class="field-input" (change)="onResourceFileSelected($event)" [attr.accept]="getResourceAcceptForSelectedType()" />
            <div class="field-error" *ngIf="resourceUploadError">{{ resourceUploadError }}</div>
            <div class="resource-uploading" *ngIf="resourceUploading">
              <span class="resource-uploading-spinner"></span>
              <span>{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù...' : 'Processing file...' }}</span>
            </div>
            <div class="resource-file-summary" *ngIf="resourceForm.fileName">
               <span class="resource-summary-icon">{{ getResourceIcon({ kind: resourceForm.displayType, fileName: resourceForm.fileName, fileType: resourceForm.fileType, fileSize: resourceForm.fileSize }) }}</span>
               <div class="resource-summary-details">
                 <span class="resource-summary-name">{{ getResourceDisplayLabelFromForm() }}</span>
                 <span class="resource-summary-meta">
                   <ng-container *ngFor="let entry of getResourceDetailEntriesFromForm(); let last = last">
                     <span class="resource-detail"><strong>{{ entry.label }}:</strong> {{ entry.value }}</span><span *ngIf="!last">{{ getResourceDetailSeparator() }}</span>
                   </ng-container>
                 </span>
               </div>
             </div>
          </div>

          <div class="field-group">
            <label class="field-label" for="resourceDescription">{{ currentLang === 'ar' ? 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø­ÙˆÙ„ Ø§Ù„Ù…Ù„Ù' : 'Resource Notes' }}</label>
            <textarea
              id="resourceDescription"
              rows="4"
              class="field-textarea"
              [(ngModel)]="resourceForm.description"
              [placeholder]="currentLang === 'ar' ? 'Ø£Ø¶Ù ÙˆØµÙØ§Ù‹ Ù‚ØµÙŠØ±Ø§Ù‹ Ø£Ùˆ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ù…Ù„Ù...' : 'Add a short description or instructions for the resource...'"
              [dir]="isRTL ? 'rtl' : 'ltr'"
              maxlength="600"></textarea>
            <div class="field-help">{{ currentLang === 'ar' ? 'Ø§ÙƒØªØ¨ Ù…Ù„Ø§Ø­Ø¸Ø§Øª ØªØ³Ø§Ø¹Ø¯ Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¹Ù„Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ù„Ù Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­.' : 'Add notes that help students use this resource effectively.' }}</div>
          </div>

          <div class="resource-preview-container" *ngIf="resourceForm.previewMode === 'inline' && resourceForm.dataUrl">
            <div class="resource-preview-header">
              <span class="preview-label">{{ currentLang === 'ar' ? 'Ù…Ø¹Ø§ÙŠÙ†Ø© Ø³Ø±ÙŠØ¹Ø©' : 'Quick Preview' }}</span>
              <span class="preview-hint">{{ currentLang === 'ar' ? 'Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ ÙÙ‚Ø·.' : 'Preview for reference only.' }}</span>
              <a 
                *ngIf="resourceForm.dataUrl" 
                class="btn-download-inline" 
                [href]="resourceForm.dataUrl" 
                [attr.download]="resourceForm.fileName || 'resource'">
                {{ currentLang === 'ar' ? 'ØªÙ†Ø²ÙŠÙ„' : 'Download' }}
              </a>
            </div>
            <div class="resource-preview-frame" *ngIf="resourceForm.displayType === 'pdf'">
              <iframe [src]="resourcePreviewSafeUrl" title="Resource preview" loading="lazy"></iframe>
            </div>
          </div>

          <div class="resource-preview-placeholder" *ngIf="resourceForm.previewMode === 'download' && resourceForm.fileName">
            <span>
              {{ currentLang === 'ar' ? 'Ù„Ù† ÙŠØªÙ… Ø¹Ø±Ø¶ Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù. Ø³ÙŠÙƒÙˆÙ† Ù…ØªØ§Ø­Ø§Ù‹ Ù„Ù„ØªÙ†Ø²ÙŠÙ„.' : 'Preview is not available for this file. It will be provided as a download.' }}
            </span>
            <a 
              *ngIf="resourceForm.dataUrl" 
              class="btn-download-inline" 
              [href]="resourceForm.dataUrl" 
              [attr.download]="resourceForm.fileName || 'resource'">
              {{ currentLang === 'ar' ? 'ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù' : 'Download File' }}
            </a>
          </div>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="closeResourceModal()" [disabled]="resourceUploadInProgress || resourceSaving">
            {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
          </button>
          <button type="button" class="btn-save" (click)="submitResource()" [disabled]="resourceSaving || resourceUploading || resourceUploadInProgress || !resourceForm.title.trim() || !resourceFile">
            {{ currentLang === 'ar' ? 'Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù' : 'Save Resource' }}
          </button>
        </div>
        <div class="resource-upload-overlay" *ngIf="resourceUploadInProgress">
          <div class="resource-upload-dialog">
            <div class="upload-spinner"></div>
            <div class="upload-progress-info">
              <span class="upload-text">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù...' : 'Uploading resource...' }}</span>
              <div class="upload-progress-bar">
                <div class="upload-progress-fill" [style.width.%]="resourceUploadProgress"></div>
              </div>
              <span class="upload-progress-value">{{ resourceUploadProgress }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Content Modal -->
    <div class="modal-overlay" *ngIf="showVideoModal">
      <div class="modal-content video-modal" (click)="$event.stopPropagation()" [dir]="isRTL ? 'rtl' : 'ltr'">
        <div class="modal-header">
          <div class="modal-header-left">
            <!-- Back button for form modes -->
            <button 
              *ngIf="!viewingVideoContent && videoForm.source"
              type="button" 
              class="btn-back-header"
              (click)="resetVideoSource()">
              <span class="back-arrow">{{ currentLang === 'ar' ? 'â†’' : 'â†' }}</span>
            </button>
            <h3>{{ viewingVideoContent ? (currentLang === 'ar' ? 'ğŸ¥ Ø¹Ø±Ø¶ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ¥ View Video') : (currentLang === 'ar' ? 'ğŸ¥ Ø¥Ø¶Ø§ÙØ© ÙÙŠØ¯ÙŠÙˆ' : 'ğŸ¥ Add Video') }}</h3>
            
            <!-- Delete button for view mode -->
            <button 
              *ngIf="viewingVideoContent && videoContentItem"
              type="button" 
              class="btn-delete-header"
              (click)="deleteVideoContent()"
              [disabled]="deletingVideo"
              [attr.aria-label]="currentLang === 'ar' ? 'Ø­Ø°Ù Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Delete Video'">
              <span *ngIf="!deletingVideo">ğŸ—‘ï¸</span>
              <span *ngIf="deletingVideo">â³</span>
            </button>
          </div>
          <button type="button" class="modal-close-btn" (click)="closeVideoModal()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
        </div>
        
        <div class="modal-body">
          <!-- View/Delete Mode -->
          <div *ngIf="viewingVideoContent && videoContentItem" class="video-view-mode">
            <div class="video-info">
              <h4 class="video-title">{{ videoContentItem.title }}</h4>
              <p class="video-description" *ngIf="videoContentItem.meta && videoContentItem.meta['description']">{{ videoContentItem.meta['description'] }}</p>
              <div class="video-metadata">
                <span class="video-duration" *ngIf="videoContentItem.meta && videoContentItem.meta['durationFormatted']">
                  <span class="meta-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ù…Ø¯Ø©:' : 'Duration:' }}</span>
                  <span class="meta-value">{{ videoContentItem.meta['durationFormatted'] }}</span>
                </span>
                <span class="video-source">
                  <span class="meta-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ù…ØµØ¯Ø±:' : 'Source:' }}</span>
                  <span class="meta-value">{{ videoContentItem.meta && videoContentItem.meta['source'] === 'youtube' ? 'YouTube' : (currentLang === 'ar' ? 'Ù…Ù„Ù Ù…Ø­Ù„ÙŠ' : 'Local File') }}</span>
                </span>
              </div>
            </div>
            
            <!-- Video Preview -->
            <div class="video-preview-container">
              <!-- YouTube Video -->
              <iframe 
                *ngIf="videoContentItem.meta && videoContentItem.meta['source'] === 'youtube' && videoContentItem.meta['youtubeEmbedUrl']"
                [src]="getYouTubeSafeUrl(videoContentItem.meta['youtubeEmbedUrl'])"
                class="video-iframe"
                frameborder="0"
                allowfullscreen
                loading="lazy">
              </iframe>
              
              <!-- Local Video -->
              <video 
                *ngIf="videoContentItem.meta && videoContentItem.meta['source'] === 'local' && videoContentItem.meta['dataUrl']"
                [src]="videoContentItem.meta['dataUrl']"
                class="video-player"
                controls
                preload="metadata">
              </video>
            </div>
            
          </div>
          
          <!-- Add/Edit Mode -->
          <div *ngIf="!viewingVideoContent" class="video-add-mode">
            <!-- Source Selection -->
            <div class="video-source-selection" *ngIf="!videoForm.source">
              <div class="selection-header">
                <div class="source-icon">ğŸ¥</div>
                <h3 class="source-prompt">{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Choose Video Source' }}</h3>
                <p class="source-subtitle">{{ currentLang === 'ar' ? 'Ø­Ø¯Ø¯ ÙƒÙŠÙ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ' : 'Select how you want to add your video content' }}</p>
              </div>
              
              <div class="source-options">
                <button 
                  type="button" 
                  class="source-option-btn"
                  (click)="selectVideoSource('local')">
                  <div class="option-icon-wrapper">
                    <span class="option-icon">ğŸ“¤</span>
                  </div>
                  <div class="option-content">
                    <span class="option-label">{{ currentLang === 'ar' ? 'Ø±ÙØ¹ Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ' : 'Upload Video File' }}</span>
                    <span class="option-desc">{{ currentLang === 'ar' ? 'MP4 Ø£Ùˆ AVI â€¢ Ø­ØªÙ‰ 100 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª' : 'MP4 or AVI â€¢ Up to 100 MB' }}</span>
                  </div>
                  <span class="option-arrow">â†’</span>
                </button>
                
                <button 
                  type="button" 
                  class="source-option-btn"
                  (click)="selectVideoSource('youtube')">
                  <div class="option-icon-wrapper">
                    <span class="option-icon">ğŸ”—</span>
                  </div>
                  <div class="option-content">
                    <span class="option-label">{{ currentLang === 'ar' ? 'ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨' : 'YouTube Video' }}</span>
                    <span class="option-desc">{{ currentLang === 'ar' ? 'Ø£Ø¶Ù Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ Ù…Ù† ÙŠÙˆØªÙŠÙˆØ¨' : 'Add a video link from YouTube' }}</span>
                  </div>
                  <span class="option-arrow">â†’</span>
                </button>
              </div>
            </div>
            
            <!-- Local Upload Form -->
            <div *ngIf="videoForm.source === 'local'" class="video-upload-form">
              <div class="form-section">
                
                <div class="file-upload-area" *ngIf="!videoForm.file">
                  <input 
                    type="file" 
                    #videoFileInput
                    accept=".mp4,.avi,video/mp4,video/x-msvideo"
                    (change)="onVideoFileSelected($event)"
                    class="file-input-hidden">
                  <button 
                    type="button"
                    class="upload-trigger-btn"
                    (click)="videoFileInput.click()">
                    <span class="upload-icon">ğŸ“¹</span>
                    <span class="upload-text">{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ± Ù…Ù„Ù ÙÙŠØ¯ÙŠÙˆ' : 'Choose Video File' }}</span>
                    <span class="upload-hint">{{ currentLang === 'ar' ? 'MP4 Ø£Ùˆ AVI (Ø­ØªÙ‰ 100 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)' : 'MP4 or AVI (up to 100 MB)' }}</span>
                  </button>
                </div>
                
                <div *ngIf="videoForm.file" class="selected-file-info">
                  <div class="file-details">
                    <span class="file-icon">ğŸ¥</span>
                    <div class="file-meta">
                      <span class="file-name">{{ videoForm.fileName }}</span>
                      <span class="file-size">{{ formatFileSize(videoForm.fileSize || 0) }}</span>
                      <span class="file-duration" *ngIf="videoForm.metadata?.durationFormatted">
                        {{ currentLang === 'ar' ? 'Ø§Ù„Ù…Ø¯Ø©:' : 'Duration:' }} {{ videoForm.metadata?.durationFormatted }}
                      </span>
                    </div>
                    <button 
                      type="button"
                      class="remove-file-btn"
                      (click)="removeVideoFile()">
                      âœ•
                    </button>
                  </div>
                </div>
                
                <div class="form-fields" *ngIf="videoForm.file">
                  <div class="form-group">
                    <label>{{ currentLang === 'ar' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Video Title' }} *</label>
                    <input 
                      type="text"
                      [(ngModel)]="videoForm.title"
                      [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Enter video title'"
                      maxlength="200"
                      required>
                  </div>
                  
                  <div class="form-group">
                    <label>{{ currentLang === 'ar' ? 'ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Video Description' }}</label>
                    <textarea 
                      [(ngModel)]="videoForm.description"
                      [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Enter a brief description (optional)'"
                      rows="3"
                      maxlength="500">
                    </textarea>
                  </div>
                </div>
                
                <div class="upload-error" *ngIf="videoUploadError">
                  <span class="error-icon">âš ï¸</span>
                  <span class="error-text">{{ videoUploadError }}</span>
                </div>
                
                <div class="upload-progress" *ngIf="videoUploadInProgress">
                  <div class="progress-bar">
                    <div class="progress-fill" [style.width.%]="videoUploadProgress"></div>
                  </div>
                  <span class="progress-text">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø±ÙØ¹...' : 'Uploading...' }} {{ videoUploadProgress }}%</span>
                </div>
              </div>
            </div>
            
            <!-- YouTube Link Form -->
            <div *ngIf="videoForm.source === 'youtube'" class="youtube-link-form">
              <div class="form-section">
                <div class="form-group">
                  <label>{{ currentLang === 'ar' ? 'Ø±Ø§Ø¨Ø· ÙÙŠØ¯ÙŠÙˆ ÙŠÙˆØªÙŠÙˆØ¨' : 'YouTube Video URL' }} *</label>
                  <input 
                    type="url"
                    [(ngModel)]="videoForm.youtubeUrl"
                    (blur)="validateYouTubeUrl()"
                    [placeholder]="currentLang === 'ar' ? 'https://www.youtube.com/watch?v=...' : 'https://www.youtube.com/watch?v=...'"
                    required>
                </div>
                
                <div class="form-actions-row">
                  <button 
                    type="button"
                    class="btn-fetch"
                    (click)="fetchYouTubeMetadata()"
                    [disabled]="!videoForm.youtubeUrl || fetchingYouTubeData">
                    <span *ngIf="!fetchingYouTubeData">{{ currentLang === 'ar' ? 'Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª' : 'Fetch Info' }}</span>
                    <span *ngIf="fetchingYouTubeData">{{ currentLang === 'ar' ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¬Ù„Ø¨...' : 'â³ Fetching...' }}</span>
                  </button>
                </div>
                
                <div class="youtube-preview" *ngIf="videoForm.youtubeData">
                  <div class="youtube-thumbnail">
                    <img [src]="videoForm.youtubeData.thumbnail" [alt]="videoForm.youtubeData.title">
                  </div>
                  <div class="youtube-info">
                    <h5>{{ videoForm.youtubeData.title }}</h5>
                    <p>{{ videoForm.youtubeData.description | slice:0:200 }}{{ videoForm.youtubeData.description.length > 200 ? '...' : '' }}</p>
                    <span class="youtube-duration">
                      {{ currentLang === 'ar' ? 'Ø§Ù„Ù…Ø¯Ø©:' : 'Duration:' }} {{ formatDuration(videoForm.youtubeData.duration) }}
                    </span>
                  </div>
                </div>
                
                <div class="form-fields" *ngIf="videoForm.youtubeData">
                  <div class="form-group">
                    <label>{{ currentLang === 'ar' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Video Title' }} *</label>
                    <input 
                      type="text"
                      [(ngModel)]="videoForm.title"
                      [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Enter video title'"
                      maxlength="200"
                      required>
                  </div>
                  
                  <div class="form-group">
                    <label>{{ currentLang === 'ar' ? 'ÙˆØµÙ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Video Description' }}</label>
                    <textarea 
                      [(ngModel)]="videoForm.description"
                      [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ ÙˆØµÙ Ù…Ø®ØªØµØ± Ù„Ù„ÙÙŠØ¯ÙŠÙˆ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Enter a brief description (optional)'"
                      rows="3"
                      maxlength="500">
                    </textarea>
                  </div>
                </div>
                
                <div class="youtube-error" *ngIf="youtubeError">
                  <span class="error-icon">âš ï¸</span>
                  <span class="error-text">{{ youtubeError }}</span>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Modal Actions -->
        <div class="modal-actions" *ngIf="!viewingVideoContent && videoForm.source && (videoForm.file || videoForm.youtubeData)">
          <button 
            type="button" 
            class="btn-cancel"
            (click)="closeVideoModal()"
            [disabled]="savingVideo || videoUploadInProgress">
            {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
          </button>
          <button 
            type="button" 
            class="btn-primary"
            (click)="saveVideoContent()"
            [disabled]="!canSaveVideo() || savingVideo || videoUploadInProgress">
            <span *ngIf="!savingVideo">{{ currentLang === 'ar' ? 'Ø­ÙØ¸ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ' : 'Save Video' }}</span>
            <span *ngIf="savingVideo">{{ currentLang === 'ar' ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'â³ Saving...' }}</span>
          </button>
        </div>
        
        <!-- Video Upload Progress Overlay -->
        <div class="video-upload-overlay" *ngIf="videoUploadInProgress">
          <div class="video-upload-dialog">
            <div class="upload-spinner"></div>
            <div class="upload-progress-info">
              <span class="upload-text">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...' : 'Uploading video...' }}</span>
              <div class="upload-progress-bar">
                <div class="upload-progress-fill" [style.width.%]="videoUploadProgress"></div>
              </div>
              <span class="upload-progress-value">{{ videoUploadProgress }}%</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Resource Preview Modal -->
    <div class="modal-overlay" *ngIf="showResourcePreviewModal">
      <div class="modal-content resource-preview-modal" (click)="$event.stopPropagation()" [dir]="isRTL ? 'rtl' : 'ltr'">
        <div class="modal-header">
          <h3>{{ currentLang === 'ar' ? 'Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù' : 'View Resource' }}</h3>
          <button type="button" class="modal-close-btn" (click)="closeResourcePreview()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
        </div>
        <div class="modal-body" *ngIf="resourcePreviewItem">
          <div class="resource-preview-info">
            <div class="resource-preview-icon">{{ getResourceIcon(resourcePreviewItem.resourceDetails) }}</div>
            <div class="resource-preview-details">
              <span class="resource-preview-title">{{ resourcePreviewItem.title }}</span>
              <span class="resource-preview-meta">
                <ng-container *ngFor="let entry of getResourceDetailEntries(resourcePreviewItem.resourceDetails); let last = last">
                  <span class="resource-detail"><strong>{{ entry.label }}:</strong> {{ entry.value }}</span><span *ngIf="!last">{{ getResourceDetailSeparator() }}</span>
                </ng-container>
              </span>
              <span class="resource-preview-date">{{ (resourcePreviewItem.updatedAt || resourcePreviewItem.createdAt) | date:'medium' }}</span>
            </div>
          </div>

          <p class="resource-preview-description" *ngIf="resourcePreviewItem.resourceDetails?.description">{{ resourcePreviewItem.resourceDetails?.description }}</p>

          <div class="resource-preview-frame" *ngIf="resourcePreviewItem.resourceDetails?.previewMode === 'inline' && resourcePreviewSafeUrl && resourcePreviewKind === 'pdf'">
            <iframe [src]="resourcePreviewSafeUrl" title="PDF preview" loading="lazy"></iframe>
          </div>

          <div class="resource-preview-placeholder" *ngIf="resourcePreviewItem.resourceDetails?.previewMode !== 'inline'">
            {{ currentLang === 'ar' ? 'Ù„Ø§ ØªØªÙˆÙØ± Ù…Ø¹Ø§ÙŠÙ†Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù. ÙŠÙ…ÙƒÙ†Ùƒ ØªÙ†Ø²ÙŠÙ„Ù‡ Ù„Ø¹Ø±Ø¶Ù‡.' : 'Preview not available for this file. Download to view it.' }}
          </div>
        </div>
        <div class="modal-actions">
          <ng-container *ngIf="resourcePreviewItem?.resourceDetails as previewDetails">
            <a
              *ngIf="previewDetails.downloadUrl || previewDetails.dataUrl"
              class="btn-primary"
              [href]="previewDetails.downloadUrl || previewDetails.dataUrl"
              [attr.download]="getResourceDownloadName(previewDetails)">
              {{ currentLang === 'ar' ? 'ØªÙ†Ø²ÙŠÙ„ Ø§Ù„Ù…Ù„Ù' : 'Download File' }}
            </a>
          </ng-container>
          <button type="button" class="btn-cancel" (click)="closeResourcePreview()">
            {{ currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close' }}
          </button>
        </div>
      </div>
    </div>
    </div>
  </div>

  <!-- Info Preview -->
  <div class="info-preview" *ngIf="selectedCategory">
    <h3>{{ currentLang === 'ar' ? 'Ø®Ø·ÙˆØ§Øª Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:' : 'Course Building Steps:' }}</h3>
    <div class="preview-grid">
      <div class="preview-item">
        <span class="preview-icon">ğŸ“</span>
        <span class="preview-title">{{ currentLang === 'ar' ? 'Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø£Ø³Ø§Ø³ÙŠØ§Øª Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©' : 'Step 1: Course Basics' }}</span>
        <span class="preview-desc">{{ currentLang === 'ar' ? 'Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ© ÙˆØ§Ù„ÙˆØ­Ø¯Ø©' : 'Name and topic' }}</span>
      </div>
      <div class="preview-item">
        <span class="preview-icon">ğŸ¯</span>
        <span class="preview-title">{{ currentLang === 'ar' ? 'Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ù…' : 'Step 2: Building Sections' }}</span>
        <span class="preview-desc">{{ currentLang === 'ar' ? 'Ø¨Ù†Ø§Ø¡ Ø§Ù„Ø§Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…' : 'Build units and sections' }}</span>
      </div>
      <div class="preview-item">
        <span class="preview-icon">ğŸš€</span>
        <span class="preview-title">{{ currentLang === 'ar' ? 'Ø§Ù„Ø®Ø·ÙˆØ© 3: Ù…Ø±Ø§Ø¬Ø¹Ø© ÙˆÙ†Ø´Ø±' : 'Step 3: Review & Publish' }}</span>
        <span class="preview-desc">{{ currentLang === 'ar' ? 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø±Ø¤ÙŠØ© ÙˆØ§Ù„Ù†Ø´Ø± Ù…Ø¹ Ù‚Ø³Ù… Ø§Ø®ØªÙŠØ§Ø±ÙŠ' : 'Set visibility and publish with optional section' }}</span>
      </div>
    </div>
  </div>
</div>

<!-- Add Section Modal -->
<div class="modal-overlay" *ngIf="showAddSectionModal" (click)="closeAddSectionModal()">
  <div class="modal-content add-section-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">{{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø¬Ø¯ÙŠØ¯' : 'Add New Section' }}</h2>
      <button type="button" class="modal-close" (click)="closeAddSectionModal()">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="add-section-options">
        <!-- Manual Entry Option -->
        <button
          type="button"
          class="section-option-btn"
          (click)="addNewSectionManually()">
          <div class="option-icon">âœï¸</div>
          <div class="option-content">
            <h3>{{ currentLang === 'ar' ? 'Ø¥Ø¯Ø®Ø§Ù„ ÙŠØ¯ÙˆÙŠ' : 'Manual Entry' }}</h3>
            <p>{{ currentLang === 'ar' ? 'Ø§ÙƒØªØ¨ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù… ÙˆØ£Ø¶Ù Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙŠØ¯ÙˆÙŠØ§Ù‹' : 'Write section title and add content manually' }}</p>
          </div>
        </button>

        <!-- AI Section (Grouped) -->
        <div class="ai-section-group">
          <div class="ai-section-header">
            <div class="option-icon">ğŸ¤–</div>
            <h3 class="ai-section-title">{{ currentLang === 'ar' ? 'Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'AI Generation' }}</h3>
          </div>
          <div class="ai-section-options">
            <!-- Upload File Option -->
            <button
              type="button"
              class="ai-sub-option-btn"
              (click)="showFileUploadSection()"
              [class.active]="sectionCreationMode === 'upload'">
              <div class="sub-option-icon">ğŸ“„</div>
              <div class="sub-option-content">
                <h4>{{ currentLang === 'ar' ? 'Ø±ÙØ¹ Ù…Ù„Ù' : 'Upload File' }}</h4>
                <p>{{ currentLang === 'ar' ? 'Ø§Ø±ÙØ¹ Ù…Ù„Ù Word/PDF/PPT ÙˆØ³ÙŠÙ‚ÙˆÙ… Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ø¨Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'Upload Word/PDF/PPT file and AI will generate content' }}</p>
              </div>
            </button>

            <!-- AI Generation Option -->
            <button
              type="button"
              class="ai-sub-option-btn"
              (click)="showAIInstructionSection()"
              [class.active]="sectionCreationMode === 'ai'">
              <div class="sub-option-icon">âœ¨</div>
              <div class="sub-option-content">
                <h4>{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'Generate with AI' }}</h4>
                <p>{{ currentLang === 'ar' ? 'Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ Ø£Ùˆ ØªØ¹Ù„ÙŠÙ…Ø§Øª Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'Write description or instructions for AI to generate content' }}</p>
              </div>
            </button>
          </div>
        </div>
      </div>

      <!-- File Upload Section -->
      <div class="section-creation-panel" *ngIf="sectionCreationMode === 'upload'">
        <input
          #sectionFileInput
          id="sectionFileInput"
          type="file"
          accept=".doc,.docx,.pdf,.ppt,.pptx,application/msword,application/vnd.openxmlformats-officedocument.wordprocessingml.document,application/pdf,application/vnd.ms-powerpoint,application/vnd.openxmlformats-officedocument.presentationml.presentation"
          (change)="onSectionFileSelected($event)"
          style="display: none;"
        />
        <button class="upload-trigger-btn" (click)="sectionFileInput.click()">
          <span class="upload-icon">ğŸ“¤</span>
          <span>{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ± Ù…Ù„Ù Ù„Ù„Ø±ÙØ¹' : 'Choose file to upload' }}</span>
        </button>
        <div class="section-upload-hint">
          <p>
            {{ currentLang === 'ar'
              ? 'ğŸ“ Ø§Ø±ÙØ¹ Ù…Ù„ÙÙ‹Ø§ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ ÙÙ‚Ø· (Ø¨Ø­Ø¯ Ø£Ù‚ØµÙ‰ 2000 ÙƒÙ„Ù…Ø©).'
              : 'ğŸ“ Upload one section per file (max 2,000 words).' }}
          </p>
          <div class="ai-upload-tips">
            <h4>{{ currentLang === 'ar' ? 'ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª:' : 'ğŸ’¡ File Upload Tips:' }}</h4>
            <ul>
              <li>{{ currentLang === 'ar' ? 'Ø§Ø³ØªØ®Ø¯Ù… Ù„ØºØ© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ù…Ù„Ù' : 'Use a single language in the file' }}</li>
              <li>{{ currentLang === 'ar' ? 'Ø£Ø¶Ù Ø¹Ù†Ø§ÙˆÙŠÙ† ÙˆØ§Ø¶Ø­Ø© Ù„Ù„Ø£Ù‚Ø³Ø§Ù…' : 'Add clear section headings' }}</li>
              <li>{{ currentLang === 'ar' ? 'Ù†Ø¸Ù… Ø§Ù„Ø£ÙÙƒØ§Ø± ÙÙŠ Ù†Ù‚Ø§Ø·' : 'Organize ideas in bullet points' }}</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- AI Instruction Section -->
      <div class="section-creation-panel" *ngIf="sectionCreationMode === 'ai'">
        <div class="ai-instruction-form">
          <label class="instruction-label">
            {{ currentLang === 'ar' ? 'Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ…Ø§ØªÙƒ Ù„Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:' : 'Write your instructions to AI:' }}
          </label>
          <textarea
            class="ai-instruction-input"
            [(ngModel)]="aiInstructionText"
            [placeholder]="currentLang === 'ar' 
              ? 'Ù…Ø«Ø§Ù„: Ø£Ø±ÙŠØ¯ Ù‚Ø³Ù…Ø§Ù‹ Ø¹Ù† Ø§Ù„ÙÙŠØ²ÙŠØ§Ø¡ Ø§Ù„ÙƒÙ…ÙŠØ© Ù„Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø§Ù…Ø¹ÙŠÙŠÙ†ØŒ ÙŠØªØ¶Ù…Ù† Ø¯Ø±ÙˆØ³ Ø¹Ù† Ø§Ù„Ù…ÙØ§Ù‡ÙŠÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØ§Ù„ØªØ·Ø¨ÙŠÙ‚Ø§Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© ÙˆØ§Ù„ØªØ¬Ø§Ø±Ø¨ Ø§Ù„Ø´Ù‡ÙŠØ±Ø©...' 
              : 'Example: I want a section about quantum physics for university students, including lessons about basic concepts, practical applications, and famous experiments...'"
            rows="6">
          </textarea>
          
          <div class="ai-instruction-tips">
            <h4>{{ currentLang === 'ar' ? 'ğŸ¯ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ù…Ù† Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ:' : 'ğŸ¯ For best AI results:' }}</h4>
            <ul>
              <li>{{ currentLang === 'ar' ? 'ğŸ“š Ø­Ø¯Ø¯ Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹ Ø¨ÙˆØ¶ÙˆØ­ ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠ Ø§Ù„Ù…Ø³ØªÙ‡Ø¯Ù' : 'ğŸ“š Clearly specify the topic and target education level' }}</li>
              <li>{{ currentLang === 'ar' ? 'ğŸ”¢ Ø§Ø°ÙƒØ± Ø¹Ø¯Ø¯ Ø§Ù„Ø¯Ø±ÙˆØ³ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (1-10 Ø¯Ø±ÙˆØ³)' : 'ğŸ”¢ Mention number of lessons needed (1-10 lessons)' }}</li>
              <li>{{ currentLang === 'ar' ? 'ğŸ“ Ø­Ø¯Ø¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ ØªØºØ·ÙŠØªÙ‡Ø§' : 'ğŸ“ Specify key points you want covered' }}</li>
              <li>{{ currentLang === 'ar' ? 'ğŸŒ Ø§Ø°ÙƒØ± Ø§Ù„Ù„ØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ø¹Ø±Ø¨ÙŠ Ø£Ùˆ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ)' : 'ğŸŒ Mention the required language (Arabic or English)' }}</li>
              <li>{{ currentLang === 'ar' ? 'ğŸ’¡ Ø£Ø¶Ù Ø£Ù…Ø«Ù„Ø© Ø£Ùˆ Ø£Ù†Ø´Ø·Ø© ØªØ±ÙŠØ¯ ØªØ¶Ù…ÙŠÙ†Ù‡Ø§' : 'ğŸ’¡ Add examples or activities you want included' }}</li>
              <li>{{ currentLang === 'ar' ? 'ğŸ¨ Ø§Ø·Ù„Ø¨ Ø¬Ø¯Ø§ÙˆÙ„ Ø£Ùˆ Ø±Ø³ÙˆÙ… Ø¨ÙŠØ§Ù†ÙŠØ© Ø¥Ø°Ø§ Ù„Ø²Ù… Ø§Ù„Ø£Ù…Ø±' : 'ğŸ¨ Request tables or diagrams if needed' }}</li>
            </ul>
          </div>
          
          <button 
            class="generate-ai-content-btn"
            (click)="generateAIContent()"
            [disabled]="!aiInstructionText || aiInstructionText.trim().length < 20">
            <span>{{ currentLang === 'ar' ? 'âœ¨ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'âœ¨ Generate Content with AI' }}</span>
          </button>
        </div>
      </div>

      <!-- File Selected Actions (shown when file is selected) -->
      <div class="section-upload-actions" *ngIf="sectionFileSelected && !sectionFileUploading">
        <p class="upload-info-text">
          {{ currentLang === 'ar' 
            ? 'ğŸ“„ Ø§Ù„Ù…Ù„Ù Ø¬Ø§Ù‡Ø² Ù„Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©. Ø³ÙŠØªÙ… ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆØ¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ø¯Ø±ÙˆØ³ Ø¨Ù†ÙØ³ Ù„ØºØ© Ø§Ù„Ù…Ù„Ù.' 
            : 'ğŸ“„ File ready to process. Content will be analyzed and section/lessons will be created in the same language as the file.' }}
        </p>
        <div class="upload-action-buttons">
          <button
            type="button"
            class="btn-primary"
            (click)="uploadSelectedSectionFile()"
            [disabled]="sectionFileUploading">
            {{ currentLang === 'ar' ? 'ğŸš€ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù‚Ø³Ù…' : 'ğŸš€ Create Section' }}
          </button>
          <button
            type="button"
            class="btn-secondary"
            (click)="clearSelectedSectionFile()"
            [disabled]="sectionFileUploading">
            {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
          </button>
        </div>
      </div>

    </div>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" (click)="closeAddSectionModal()" [disabled]="sectionFileUploading">
        {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
      </button>
    </div>
  </div>
</div>

<!-- Progress Modal (Used for both File Upload and AI Generation) -->
<div class="modal-overlay file-upload-progress-overlay" *ngIf="sectionFileUploading || sectionFileUploadError">
  <div class="modal-content file-upload-progress-modal" [dir]="isRTL ? 'rtl' : 'ltr'">
    <div class="progress-modal-header">
      <h2 class="progress-modal-title">
        {{ sectionFileUploadError
          ? (aiGenerating 
            ? (currentLang === 'ar' ? 'ØªØ¹Ø°Ø± Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'Content Generation Issue')
            : (currentLang === 'ar' ? 'ØªØ¹Ø°Ø± Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù' : 'File Processing Issue'))
          : (aiGenerating
            ? (currentLang === 'ar' ? 'ğŸ¤– Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'ğŸ¤– AI Content Generation')
            : (currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ù' : 'Processing File')) }}
      </h2>
      <div class="progress-percentage-badge" *ngIf="!sectionFileUploadError">{{ sectionFileUploadProgress }}%</div>
    </div>
    
    <div class="progress-modal-body">
      <!-- Main Progress Bar -->
      <div class="main-progress-section" *ngIf="!sectionFileUploadError">
        <div class="progress-bar-container">
          <div class="progress-bar-track">
            <div class="progress-bar-fill" [style.width.%]="sectionFileUploadProgress"></div>
          </div>
        </div>
        <p class="current-step-text">{{ sectionFileUploadStep || (currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...' : 'Processing...') }}</p>
      </div>
      
      <!-- Dhikr / Istighfar Display -->
      <div class="dhikr-container" *ngIf="sectionFileUploading && !sectionFileUploadError">
        <div class="dhikr-wrapper">
          <div class="dhikr-text" [@fadeInOut]>
            {{ currentDhikr }}
          </div>
          <div class="dhikr-translation" *ngIf="currentDhikrTranslation">
            {{ currentDhikrTranslation }}
          </div>
        </div>
        <p class="dhikr-reminder">
          {{ currentLang === 'ar' 
            ? 'âœ¨ Ø§Ø°ÙƒØ± Ø§Ù„Ù„Ù‡ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± âœ¨' 
            : 'âœ¨ Remember Allah while waiting âœ¨' }}
        </p>
      </div>
      
      <!-- Steps List -->
      <div class="progress-steps-container">
        <!-- File Upload Steps (shown when not AI generation) -->
        <ng-container *ngIf="!aiGenerating">
          <div class="progress-step-card" [class.active]="sectionFileUploadProgress >= 20 && sectionFileUploadProgress < 50" [class.completed]="sectionFileUploadProgress >= 50">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-icon-wrapper">
                <span class="step-icon" *ngIf="sectionFileUploadProgress < 20">ğŸ“¤</span>
                <span class="step-icon loading" *ngIf="sectionFileUploadProgress >= 20 && sectionFileUploadProgress < 50">â³</span>
                <span class="step-icon completed" *ngIf="sectionFileUploadProgress >= 50">âœ…</span>
              </div>
              <div class="step-info">
                <h4 class="step-title">{{ currentLang === 'ar' ? 'Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù' : 'Uploading File' }}</h4>
                <p class="step-description">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…' : 'Uploading file to server' }}</p>
              </div>
            </div>
          </div>
          
          <div class="progress-step-card" [class.active]="sectionFileUploadProgress >= 50 && sectionFileUploadProgress < 70" [class.completed]="sectionFileUploadProgress >= 70">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-icon-wrapper">
                <span class="step-icon" *ngIf="sectionFileUploadProgress < 50">ğŸ“„</span>
                <span class="step-icon loading" *ngIf="sectionFileUploadProgress >= 50 && sectionFileUploadProgress < 70">â³</span>
                <span class="step-icon completed" *ngIf="sectionFileUploadProgress >= 70">âœ…</span>
              </div>
              <div class="step-info">
                <h4 class="step-title">{{ currentLang === 'ar' ? 'Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ' : 'Extracting Text' }}</h4>
                <p class="step-description">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù†Øµ Ù…Ù† Ø§Ù„Ù…Ù„Ù' : 'Extracting text from file' }}</p>
              </div>
            </div>
          </div>
          
          <div class="progress-step-card" [class.active]="sectionFileUploadProgress >= 70 && sectionFileUploadProgress < 90" [class.completed]="sectionFileUploadProgress >= 90">
            <div class="step-number">3</div>
            <div class="step-content">
              <div class="step-icon-wrapper">
                <span class="step-icon" *ngIf="sectionFileUploadProgress < 70">ğŸ”</span>
                <span class="step-icon loading" *ngIf="sectionFileUploadProgress >= 70 && sectionFileUploadProgress < 90">â³</span>
                <span class="step-icon completed" *ngIf="sectionFileUploadProgress >= 90">âœ…</span>
              </div>
              <div class="step-info">
                <h4 class="step-title">{{ currentLang === 'ar' ? 'ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰' : 'Analyzing Content' }}</h4>
                <p class="step-description">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…Ø­ØªÙˆÙ‰ ÙˆÙÙ‡Ù…Ù‡' : 'Analyzing and understanding content' }}</p>
              </div>
            </div>
          </div>
          
          <div class="progress-step-card" [class.active]="sectionFileUploadProgress >= 90 && sectionFileUploadProgress < 100" [class.completed]="sectionFileUploadProgress >= 100">
            <div class="step-number">4</div>
            <div class="step-content">
              <div class="step-icon-wrapper">
                <span class="step-icon" *ngIf="sectionFileUploadProgress < 90">âœ¨</span>
                <span class="step-icon loading" *ngIf="sectionFileUploadProgress >= 90 && sectionFileUploadProgress < 100">â³</span>
                <span class="step-icon completed" *ngIf="sectionFileUploadProgress >= 100">âœ…</span>
              </div>
              <div class="step-info">
                <h4 class="step-title">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯Ø±ÙˆØ³' : 'Generating Lessons' }}</h4>
                <p class="step-description">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¯Ø±ÙˆØ³ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ' : 'Generating lessons and educational content' }}</p>
              </div>
            </div>
          </div>
        </ng-container>
        
        <!-- AI Generation Steps (shown only during AI generation, hide completed steps) -->
        <ng-container *ngIf="aiGenerating">
          <!-- Step 1: Generate Section Title (shown only when active) -->
          <div class="progress-step-card" *ngIf="aiGenerationStep === 1" [class.active]="true">
            <div class="step-number">1</div>
            <div class="step-content">
              <div class="step-icon-wrapper">
                <span class="step-icon loading">â³</span>
              </div>
              <div class="step-info">
                <h4 class="step-title">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ù‚Ø³Ù…' : 'Creating Section Title' }}</h4>
                <p class="step-description">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ÙˆØ§Ù† Ù…Ù†Ø§Ø³Ø¨ Ù„Ù„Ù‚Ø³Ù…' : 'Creating an appropriate section title' }}</p>
              </div>
            </div>
          </div>
          
          <!-- Step 2: Generate Lesson Titles (shown only when active) -->
          <div class="progress-step-card" *ngIf="aiGenerationStep === 2" [class.active]="true">
            <div class="step-number">2</div>
            <div class="step-content">
              <div class="step-icon-wrapper">
                <span class="step-icon loading">â³</span>
              </div>
              <div class="step-info">
                <h4 class="step-title">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ÙˆÙŠÙ† Ø§Ù„Ø¯Ø±ÙˆØ³' : 'Creating Lesson Titles' }}</h4>
                <p class="step-description">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†Ø§ÙˆÙŠÙ† Ù…Ù†Ø§Ø³Ø¨Ø© Ù„Ù„Ø¯Ø±ÙˆØ³' : 'Creating appropriate lesson titles' }}</p>
              </div>
            </div>
          </div>
          
        </ng-container>
      </div>
      
      <!-- Error Display -->
      <div class="progress-error" *ngIf="sectionFileUploadError">
        <div class="error-icon">âš ï¸</div>
        <p class="error-message">{{ sectionFileUploadError }}</p>
        <button type="button" class="btn-primary retry-btn" (click)="clearSectionFileError()">
          {{ currentLang === 'ar' ? 'ÙÙ‡Ù…ØªØŒ Ø³Ø£Ù‚Ø³Ù… Ø§Ù„Ù…Ù„Ù' : 'Got it, I will split the file' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Section Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteSectionModal" (click)="cancelDeleteSection()">
  <div class="modal-content delete-section-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">{{ currentLang === 'ar' ? 'Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù…ØŸ' : 'Delete this section?' }}</h2>
      <button type="button" class="modal-close" (click)="cancelDeleteSection()">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="delete-message">{{ currentLang === 'ar' ? 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… ÙˆØ¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª Ø¨Ø¯Ø§Ø®Ù„Ù‡ Ø¨Ø´ÙƒÙ„ Ù†Ù‡Ø§Ø¦ÙŠ.' : 'This will permanently delete the section and everything inside it.' }}</p>
      <p class="delete-warning" *ngIf="sectionToDelete?.content_items?.length">
        {{ currentLang === 'ar' ? 'Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡. ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© delete Ù„Ù„ØªØ£ÙƒÙŠØ¯.' : 'This action cannot be undone. Please type delete to confirm.' }}
      </p>
      <p class="delete-section-name" *ngIf="sectionToDelete">{{ sectionToDelete.name }}</p>
      <div class="delete-confirm-field" *ngIf="sectionToDelete?.content_items?.length">
        <label for="delete-confirm-input">{{ currentLang === 'ar' ? 'Ø§ÙƒØªØ¨ delete Ù„Ù„ØªØ£ÙƒÙŠØ¯' : 'Type delete to confirm' }}</label>
        <input
          id="delete-confirm-input"
          type="text"
          [(ngModel)]="deleteConfirmationInput"
          (keydown.enter)="canConfirmDeleteSection() ? confirmDeleteSection() : null"
          [attr.placeholder]="deleteKeyword"
          autocomplete="off"
        />
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" (click)="cancelDeleteSection()" [disabled]="sectionDeleting">
        {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
      </button>
      <button type="button" class="btn-delete" (click)="confirmDeleteSection()" [disabled]="sectionDeleting || (sectionRequiresConfirmation() && !canConfirmDeleteSection())" [attr.aria-busy]="sectionDeleting">
        <span *ngIf="sectionDeleting" class="btn-spinner" aria-hidden="true"></span>
        <span>{{ currentLang === 'ar' ? 'Ù†Ø¹Ù…ØŒ Ø­Ø°Ù' : 'Yes, delete' }}</span>
      </button>
    </div>
  </div>
</div>

<!-- Start from Scratch Modal -->
<div class="modal-overlay" *ngIf="showStartFromScratchModal" (click)="showStartFromScratchModal = false">
  <div class="modal-content start-from-scratch-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">{{ currentLang === 'ar' ? 'Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯' : 'Start from Scratch' }}</h2>
      <button type="button" class="modal-close" (click)="showStartFromScratchModal = false">âœ•</button>
    </div>
    <div class="modal-body">
      <p class="warning-message">{{ currentLang === 'ar' ? 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ùƒ ØªØ±ÙŠØ¯ Ø­Ø°Ù ÙƒÙ„ Ø´ÙŠØ¡ ÙˆØ§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø¬Ø¯ÙŠØ¯ØŸ' : 'Are you sure you want to delete everything and start from scratch?' }}</p>
      <p class="warning-details">{{ currentLang === 'ar' ? 'Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© Ø¨Ù…Ø§ ÙÙŠ Ø°Ù„Ùƒ Ø§Ù„Ù…Ø§Ø¯Ø©ØŒ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…ØŒ ÙˆØ§Ù„Ù…Ø­ØªÙˆÙ‰. Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡.' : 'All saved data will be deleted including course, sections, and content. This action cannot be undone.' }}</p>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" (click)="showStartFromScratchModal = false">
        {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
      </button>
      <button 
        type="button" 
        class="btn-delete" 
        (click)="confirmStartFromScratch()"
        [disabled]="deletingDraftCourse"
        [attr.aria-busy]="deletingDraftCourse">
        <span *ngIf="deletingDraftCourse" class="btn-spinner" aria-hidden="true"></span>
        <span>{{ currentLang === 'ar' ? 'Ù†Ø¹Ù…ØŒ Ø§Ø¨Ø¯Ø£ Ù…Ù† Ø¬Ø¯ÙŠØ¯' : 'Yes, Start from Scratch' }}</span>
      </button>
    </div>
  </div>
</div>

<!-- Undo Toast (shown after section deletion) -->
<div class="undo-toast" *ngIf="showUndoToast" [class.show]="showUndoToast" [dir]="isRTL ? 'rtl' : 'ltr'">
  <div class="toast-content">
    <span class="toast-message">{{ currentLang === 'ar' ? 'ØªÙ… Ø§Ù„Ø­Ø°Ù' : 'Section deleted' }}</span>
    <button type="button" class="btn-undo" (click)="undoDeleteSection()">
      {{ currentLang === 'ar' ? 'ØªØ±Ø§Ø¬Ø¹' : 'Undo' }}
    </button>
  </div>
</div>

<!-- Delete Cover Confirmation Modal -->
<div class="modal-overlay" *ngIf="showDeleteCoverModal" (click)="showDeleteCoverModal = false">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ deleteCoverTitle }}</h3>
      <button type="button" class="modal-close-btn" (click)="showDeleteCoverModal = false" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
    </div>
    <div class="modal-body">
      <p>{{ deleteCoverMessage }}</p>
    </div>
    <div class="modal-actions">
      <button class="btn-cancel" (click)="showDeleteCoverModal = false" [disabled]="courseCoverUploading">
        {{ currentLang === 'ar' ? 'ØªØ±Ø§Ø¬Ø¹' : 'Cancel' }}
      </button>
      <button class="btn-confirm" (click)="confirmDeleteCover()" [disabled]="courseCoverUploading">
        <span *ngIf="!courseCoverUploading">{{ currentLang === 'ar' ? 'Ø­Ø°Ù' : 'Delete' }}</span>
        <span *ngIf="courseCoverUploading" class="btn-loading">
          <span class="spinner"></span>
          <span>{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø°Ù...' : 'Deleting...' }}</span>
        </span>
      </button>
    </div>
  </div>
</div>

<!-- Audio Content Modal -->
<div class="modal-overlay" *ngIf="showAudioModal">
  <div class="modal-content audio-modal" (click)="$event.stopPropagation()" [dir]="isRTL ? 'rtl' : 'ltr'">
    <div class="modal-header">
      <div class="modal-header-left">
        <!-- Back button for form modes -->
        <button 
          *ngIf="!viewingAudioContent && audioForm.source"
          type="button" 
          class="btn-back-header"
          (click)="resetAudioSource()">
          <span class="back-arrow">{{ currentLang === 'ar' ? 'â†’' : 'â†' }}</span>
        </button>
        <h3>{{ viewingAudioContent ? (currentLang === 'ar' ? 'ğŸµ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ' : 'ğŸµ View Audio') : (currentLang === 'ar' ? 'ğŸµ Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ù ØµÙˆØªÙŠ' : 'ğŸµ Add Audio') }}</h3>
        
        <!-- Edit button for view mode -->
        <button 
          *ngIf="viewingAudioContent && audioContentItem"
          type="button" 
          class="btn-edit-header"
          (click)="editAudioContent()"
          [attr.aria-label]="currentLang === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ' : 'Edit Audio'">
          âœï¸
        </button>
        
        <!-- Delete button for view mode -->
        <button 
          *ngIf="viewingAudioContent && audioContentItem"
          type="button" 
          class="btn-delete-header"
          (click)="deleteAudioContent()"
          [disabled]="deletingAudio"
          [attr.aria-label]="currentLang === 'ar' ? 'Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ' : 'Delete Audio'">
          <span *ngIf="!deletingAudio">ğŸ—‘ï¸</span>
          <span *ngIf="deletingAudio">â³</span>
        </button>
      </div>
      <button type="button" class="modal-close-btn" (click)="closeAudioModal()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
    </div>
    
    <div class="modal-body">
      <!-- View Mode -->
      <div *ngIf="viewingAudioContent && audioContentItem" class="audio-view-mode">
        <div class="audio-info">
          <h4 class="audio-title">{{ audioContentItem.title }}</h4>
          <p class="audio-description" *ngIf="audioContentItem.meta && audioContentItem.meta['description']">{{ audioContentItem.meta['description'] }}</p>
          <div class="audio-metadata">
            <span class="audio-duration" *ngIf="audioContentItem.meta && audioContentItem.meta['durationFormatted']">
              <span class="meta-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ù…Ø¯Ø©:' : 'Duration:' }}</span>
              {{ audioContentItem.meta['durationFormatted'] }}
            </span>
            <span class="audio-size" *ngIf="audioContentItem.meta && audioContentItem.meta['fileSize']">
              <span class="meta-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ø­Ø¬Ù…:' : 'Size:' }}</span>
              {{ formatFileSize(+audioContentItem.meta['fileSize']) }}
            </span>
            <span class="audio-source" *ngIf="audioContentItem.meta && audioContentItem.meta['provider']">
              <span class="meta-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ù…ØµØ¯Ø±:' : 'Source:' }}</span>
              {{ audioContentItem.meta['provider'] === 'upload' ? (currentLang === 'ar' ? 'Ø±ÙØ¹ Ù…Ù„Ù' : 'File Upload') : 
                 audioContentItem.meta['provider'] === 'convert' ? (currentLang === 'ar' ? 'ØªØ­ÙˆÙŠÙ„ Ù†Øµ' : 'Text Conversion') :
                 audioContentItem.meta['provider'] === 'generate' ? (currentLang === 'ar' ? 'ØªÙˆÙ„ÙŠØ¯ Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'AI Generated') : 
                 audioContentItem.meta['provider'] }}
            </span>
          </div>
        </div>
        
        <div class="audio-player-container">
          <audio 
            *ngIf="audioContentItem.meta && audioContentItem.meta['dataUrl']"
            [src]="audioContentItem.meta['dataUrl']"
            class="audio-player"
            controls
            preload="metadata">
          </audio>
        </div>
      </div>
      
      <!-- Add/Edit Mode -->
      <div *ngIf="!viewingAudioContent" class="audio-add-mode">
        <!-- Source Selection -->
        <div class="audio-source-selection" *ngIf="!audioForm.source">
          <div class="selection-header">
            <div class="source-icon">ğŸµ</div>
            <h3 class="source-prompt">{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ' : 'Choose Audio Source' }}</h3>
            <p class="source-subtitle">{{ currentLang === 'ar' ? 'Ø­Ø¯Ø¯ ÙƒÙŠÙ ØªØ±ÙŠØ¯ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙˆØªÙŠ Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ' : 'Select how you want to add your audio content' }}</p>
          </div>
          
          <div class="source-options two-options">
            <button type="button" class="source-option-btn" (click)="selectAudioSource('upload')">
              <div class="option-icon-wrapper">
                <span class="option-icon">ğŸ“¤</span>
              </div>
              <h4 class="option-title">{{ currentLang === 'ar' ? 'Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ' : 'Upload Audio File' }}</h4>
              <p class="option-description">{{ currentLang === 'ar' ? 'Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ Ù…Ù† Ø¬Ù‡Ø§Ø²Ùƒ' : 'Upload an audio file from your device' }}</p>
            </button>
            
            <button type="button" class="source-option-btn" (click)="selectAudioSource('convert')">
              <div class="option-icon-wrapper">
                <span class="option-icon">ğŸ”„</span>
              </div>
              <h4 class="option-title">{{ currentLang === 'ar' ? 'ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ ØµÙˆØª' : 'Convert Text to Audio' }}</h4>
              <p class="option-description">{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ± Ø¯Ø±Ø³Ù‹Ø§ Ù†ØµÙŠÙ‹Ø§ Ø£Ùˆ Ø£Ø¯Ø®Ù„ Ù†ØµÙ‹Ø§ Ù…Ø®ØµØµÙ‹Ø§' : 'Select a text lesson or enter custom text' }}</p>
            </button>
          </div>
        </div>
        
        <!-- Upload Audio Form -->
        <div *ngIf="audioForm.source === 'upload'" class="audio-upload-form">
          <h3 class="form-section-title">
            <span>ğŸ“¤</span>
            {{ currentLang === 'ar' ? 'Ø±ÙØ¹ Ù…Ù„Ù ØµÙˆØªÙŠ' : 'Upload Audio File' }}
          </h3>
          
          <!-- Existing Audio Preview (in edit mode) -->
          <div class="existing-audio-preview" *ngIf="audioForm.existingUrl">
            <p class="preview-label">{{ currentLang === 'ar' ? 'Ø§Ù„ØµÙˆØª Ø§Ù„Ø­Ø§Ù„ÙŠ:' : 'Current Audio:' }}</p>
            <audio [src]="audioForm.existingUrl" controls class="existing-audio-player"></audio>
            <p class="preview-hint">{{ currentLang === 'ar' ? 'Ø±ÙØ¹ Ù…Ù„Ù Ø¬Ø¯ÙŠØ¯ Ø³ÙŠØ³ØªØ¨Ø¯Ù„ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù.' : 'Uploading a new file will replace this one.' }}</p>
          </div>

          <!-- Common Fields: Title and Description -->
          <div class="form-field">
            <label for="audio-upload-title" class="field-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Title' }}</label>
            <input id="audio-upload-title" type="text" class="field-input" [(ngModel)]="audioForm.title" [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ù„Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ' : 'Enter a title for the audio'">
          </div>
          
          <div class="form-field">
            <label for="audio-upload-description" class="field-label">{{ currentLang === 'ar' ? 'Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Description (Optional)' }}</label>
            <textarea id="audio-upload-description" class="field-textarea" [(ngModel)]="audioForm.description" [placeholder]="currentLang === 'ar' ? 'Ø£Ø¶Ù ÙˆØµÙÙ‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§' : 'Add a brief description'"></textarea>
          </div>

          <!-- File Upload Area -->
          <div class="file-upload-container">
            <div class="file-drop-zone" (click)="audioFileInput.click()" (dragover)="onDragOver($event)" (dragleave)="onDragLeave($event)" (drop)="onDrop($event)">
              <input #audioFileInput type="file" (change)="onAudioFileSelected($event)" accept=".mp3,.wav,.m4a,.ogg" class="file-input">
              <div class="upload-icon">ğŸ“¤</div>
              <p class="upload-text">{{ currentLang === 'ar' ? 'Ø§Ø³Ø­Ø¨ ÙˆØ£ÙÙ„Øª Ù…Ù„ÙÙ‹Ø§ ØµÙˆØªÙŠÙ‹Ø§ Ø£Ùˆ Ø§Ù†Ù‚Ø± Ù„Ù„ØªØµÙØ­' : 'Drag & drop an audio file or click to browse' }}</p>
              <p class="upload-hint">{{ currentLang === 'ar' ? 'MP3, WAV, M4A, OGG (Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ 10 Ù…ÙŠØ¬Ø§Ø¨Ø§ÙŠØª)' : 'MP3, WAV, M4A, OGG (Max 10MB)' }}</p>
            </div>
            <div *ngIf="audioUploadError" class="upload-error">{{ audioUploadError }}</div>
            <div *ngIf="audioForm.fileName" class="file-preview">
              <span class="file-icon">ğŸµ</span>
              <div class="file-info">
                <p class="file-name">{{ audioForm.fileName }}</p>
                <p class="file-size">{{ formatFileSize(audioForm.fileSize) }}</p>
              </div>
              <button type="button" class="remove-file-btn" (click)="audioForm.file = null; audioForm.fileName = ''">âœ•</button>
            </div>
          </div>
          
          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="resetAudioSource()">{{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}</button>
            <button type="button" class="btn-primary" (click)="saveAudioContent()" [disabled]="!canSaveAudio() || savingAudio || audioUploadInProgress">
              <span *ngIf="savingAudio" class="btn-spinner"></span>
              <span *ngIf="!savingAudio">{{ currentLang === 'ar' ? 'Ø­ÙØ¸ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ' : 'Save Audio' }}</span>
              <span *ngIf="savingAudio">{{ currentLang === 'ar' ? 'â³ Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...' : 'â³ Saving...' }}</span>
            </button>
          </div>
        </div>
        
        <!-- Convert Text Lesson Form -->
        <div *ngIf="audioForm.source === 'convert'" class="audio-convert-form">
          <h3 class="form-section-title">
            <span>ğŸ”„</span>
            {{ currentLang === 'ar' ? 'ØªØ­ÙˆÙŠÙ„ Ù†Øµ Ø¥Ù„Ù‰ ØµÙˆØª' : 'Convert Text to Audio' }}
          </h3>

          <!-- Common Fields: Title and Description -->
          <div class="form-field">
            <label for="audio-convert-title" class="field-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ø¹Ù†ÙˆØ§Ù†' : 'Title' }}</label>
            <input id="audio-convert-title" type="text" class="field-input" [(ngModel)]="audioForm.title" [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ø¹Ù†ÙˆØ§Ù†Ù‹Ø§ Ù„Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ' : 'Enter a title for the audio'">
          </div>

          <div class="form-field">
            <label for="audio-convert-description" class="field-label">{{ currentLang === 'ar' ? 'Ø§Ù„ÙˆØµÙ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'Description (Optional)' }}</label>
            <textarea id="audio-convert-description" class="field-textarea" [(ngModel)]="audioForm.description" [placeholder]="currentLang === 'ar' ? 'Ø£Ø¶Ù ÙˆØµÙÙ‹Ø§ Ù…ÙˆØ¬Ø²Ù‹Ø§' : 'Add a brief description'"></textarea>
          </div>

          <!-- Text Source Selection -->
          <div class="form-field">
            <label class="field-label">{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ± Ù…ØµØ¯Ø± Ø§Ù„Ù†Øµ' : 'Choose Text Source' }}</label>
            <div class="text-source-options">
              <button type="button" [class.active]="audioForm.textSource === 'lesson'" (click)="audioForm.textSource = 'lesson'">{{ currentLang === 'ar' ? 'Ù…Ù† Ø¯Ø±Ø³ Ù†ØµÙŠ' : 'From Text Lesson' }}</button>
              <button type="button" [class.active]="audioForm.textSource === 'custom'" (click)="audioForm.textSource = 'custom'">{{ currentLang === 'ar' ? 'Ù†Øµ Ù…Ø®ØµØµ' : 'Custom Text' }}</button>
            </div>
          </div>

          <!-- Text Lesson Selection -->
          <div *ngIf="audioForm.textSource === 'lesson'" class="form-field">
            <div class="lesson-list">
              <div class="lesson-loading" *ngIf="textLessonsLoading">
                <span class="spinner-sm" aria-hidden="true"></span>
                <span class="loading-text">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø±ÙˆØ³...' : 'Loading lessons...' }}</span>
              </div>
              <div *ngFor="let lesson of textLessons" class="lesson-item" [class.selected]="audioForm.selectedTextLessonId === lesson.id" (click)="selectTextLesson(lesson)">
                <div class="lesson-item-inner">
                  <div class="lesson-icon" aria-hidden="true">ğŸ“</div>
                  <div class="lesson-text">
                    <h5 class="lesson-title">{{ lesson.title }}</h5>
                    <p class="lesson-preview">{{ lesson.meta?.['preview'] || '' }}</p>
                  </div>
                  <div class="lesson-select-indicator" *ngIf="audioForm.selectedTextLessonId === lesson.id" aria-hidden="true">âœ”ï¸</div>
                </div>
              </div>
              <div *ngIf="!textLessonsLoading && textLessons.length === 0" class="no-lessons">
                {{ currentLang === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø±ÙˆØ³ Ù†ØµÙŠØ© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯.' : 'No text lessons in this section yet.' }}
              </div>
            </div>
          </div>

          <!-- Custom Text Input -->
          <div *ngIf="audioForm.textSource === 'custom'" class="form-field">
            <textarea class="field-textarea text-content-input" [(ngModel)]="audioForm.textContent" [placeholder]="currentLang === 'ar' ? 'Ø§ÙƒØªØ¨ Ø£Ùˆ Ø§Ù„ØµÙ‚ Ø§Ù„Ù†Øµ Ù‡Ù†Ø§...' : 'Type or paste your text here...'"></textarea>
          </div>

          <!-- Voice & Speed Controls -->
          <div class="tts-controls">
            <div class="form-field">
              <label for="audio-convert-voice" class="field-label">{{ currentLang === 'ar' ? 'Ø§Ù„ØµÙˆØª' : 'Voice' }}</label>
              <select id="audio-convert-voice" class="field-select" [(ngModel)]="audioForm.voice">
                <option *ngFor="let voice of ttsVoices" [value]="voice.value">{{ currentLang === 'ar' ? voice.labelAr : voice.labelEn }}</option>
              </select>
            </div>
            <div class="form-field">
              <label for="audio-convert-speed" class="field-label">{{ currentLang === 'ar' ? 'Ø§Ù„Ø³Ø±Ø¹Ø©' : 'Speed' }} ({{ audioForm.speed.toFixed(1) }}x)</label>
              <input id="audio-convert-speed" type="range" class="field-range" [(ngModel)]="audioForm.speed" min="0.5" max="2.0" step="0.1">
            </div>
          </div>

          <div class="form-actions">
            <button type="button" class="btn-cancel" (click)="resetAudioSource()">
              {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
            </button>
            <button 
              type="button" 
              class="btn-primary"
              (click)="saveAudioContent()"
              [disabled]="!canSaveAudio() || savingAudio || generatingAudio">
              <span *ngIf="generatingAudio" class="btn-spinner"></span>
              <span *ngIf="!generatingAudio">{{ currentLang === 'ar' ? 'ØªØ­ÙˆÙŠÙ„ Ø¥Ù„Ù‰ ØµÙˆØª' : 'Convert to Audio' }}</span>
              <span *ngIf="generatingAudio">{{ currentLang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±...' : 'Please wait...' }}</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- Audio Upload Progress Overlay -->
      <div class="audio-upload-overlay" *ngIf="audioUploadInProgress || generatingAudio">
        <div class="audio-upload-dialog">
          <div class="upload-spinner"></div>
          <div class="upload-progress-info">
            <span class="upload-text">
              {{ audioUploadInProgress ? 
                (currentLang === 'ar' ? 'Ø¬Ø§Ø±ÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø§Ù„ØµÙˆØªÙŠ...' : 'Uploading audio file...') :
                (currentLang === 'ar' ? 'ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±... Ø¬Ø§Ø±ÙŠ ØªÙˆÙ„ÙŠØ¯ Ø§Ù„ØµÙˆØª' : 'Please wait... Generating audio') }}
            </span>
            <div class="upload-progress-bar" *ngIf="audioUploadInProgress">
              <div class="upload-progress-fill" [style.width.%]="audioUploadProgress"></div>
            </div>
            <span class="upload-progress-value" *ngIf="audioUploadInProgress">{{ audioUploadProgress }}%</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quiz Creation Wizard Modal -->
<div class="modal-overlay" *ngIf="showQuizWizardModal">
  <div class="modal-content quiz-wizard-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ø®ØªØ¨Ø§Ø±' : 'Create Quiz' }}</h3>
      <button type="button" class="modal-close-btn" (click)="closeQuizWizard()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
    </div>
    <div class="modal-body">
      <!-- Step 1: Mode Selection -->
      <div class="wizard-step" *ngIf="!quizMode">
        <h4>{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ± Ù†Ù…Ø· Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Choose Quiz Mode' }}</h4>
        <div class="mode-options">
          <button type="button" class="mode-option-btn" (click)="selectQuizMode('manual')">
            <div class="mode-icon">âœï¸</div>
            <div class="mode-title">{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ¨Ø§Ø± ÙŠØ¯ÙˆÙŠ' : 'Manual Quiz' }}</div>
            <div class="mode-description">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹' : 'Create questions manually' }}</div>
          </button>
          <button type="button" class="mode-option-btn" (click)="selectQuizMode('ai')">
            <div class="mode-icon">ğŸ¤–</div>
            <div class="mode-title">{{ currentLang === 'ar' ? 'Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'AI Quiz' }}</div>
            <div class="mode-description">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù…Ù† Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‚Ø³Ù…' : 'Generate questions automatically from section content' }}</div>
          </button>
        </div>
      </div>

      <!-- Step 2: Settings -->
      <div class="wizard-step" *ngIf="quizMode">
        <h4>{{ currentLang === 'ar' ? 'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Quiz Settings' }}</h4>
        <div class="form-field">
          <label for="quizTitle">{{ currentLang === 'ar' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Quiz Title' }}</label>
          <input
            id="quizTitle"
            type="text"
            class="field-input"
            [(ngModel)]="quizSettings.title"
            [placeholder]="currentLang === 'ar' ? 'Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Quiz Title'"
            maxlength="200"
          />
        </div>
        <div class="form-field">
          <label for="fullScore">{{ currentLang === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ' : 'Full Score' }}</label>
          <input
            id="fullScore"
            type="number"
            class="field-input"
            [(ngModel)]="quizSettings.full_score"
            min="1"
            [placeholder]="currentLang === 'ar' ? 'Ù…Ø«Ø§Ù„: 40' : 'e.g. 40'"
          />
        </div>
        <div class="form-field">
          <label for="timeLimit">{{ currentLang === 'ar' ? 'Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø­Ø¯Ø¯ (Ø¨Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚)' : 'Time Limit (in minutes)' }}</label>
          <input
            id="timeLimit"
            type="number"
            class="field-input"
            [(ngModel)]="quizSettings.time_limit"
            min="1"
            [placeholder]="currentLang === 'ar' ? 'Ù…Ø«Ø§Ù„: 30 (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)' : 'e.g. 30 (optional)'"
          />
          <p class="field-hint">{{ currentLang === 'ar' ? 'Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±ØºØ§Ù‹ Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø­Ø¯ Ø²Ù…Ù†ÙŠ' : 'Leave empty if there is no time limit' }}</p>
        </div>
        <div class="form-field">
          <label>{{ currentLang === 'ar' ? 'Ø£Ù†ÙˆØ§Ø¹ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©' : 'Allowed Question Types' }}</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" [checked]="quizSettings.allowed_types.includes('mcq')" (change)="toggleQuestionType('mcq')" />
              {{ currentLang === 'ar' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 'Multiple Choice' }}
            </label>
            <label class="checkbox-label">
              <input type="checkbox" [checked]="quizSettings.allowed_types.includes('true_false')" (change)="toggleQuestionType('true_false')" />
              {{ currentLang === 'ar' ? 'ØµØ­ÙŠØ­/Ø®Ø·Ø£' : 'True/False' }}
            </label>
            <label class="checkbox-label">
              <input type="checkbox" [checked]="quizSettings.allowed_types.includes('matching')" (change)="toggleQuestionType('matching')" />
              {{ currentLang === 'ar' ? 'Ù…Ø·Ø§Ø¨Ù‚Ø©' : 'Matching' }}
            </label>
            <label class="checkbox-label">
              <input type="checkbox" [checked]="quizSettings.allowed_types.includes('ordering')" (change)="toggleQuestionType('ordering')" />
              {{ currentLang === 'ar' ? 'ØªØ±ØªÙŠØ¨' : 'Ordering' }}
            </label>
          </div>
        </div>
        <div class="form-field">
          <label class="checkbox-label">
            <input type="checkbox" [(ngModel)]="quizSettings.auto_weighting" />
            {{ currentLang === 'ar' ? 'ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù†Ù‚Ø§Ø· ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹' : 'Auto-distribute points' }}
          </label>
        </div>
        <div class="modal-actions">
          <button type="button" class="btn-cancel" (click)="quizMode = null" [disabled]="creatingQuiz">
            {{ currentLang === 'ar' ? 'Ø±Ø¬ÙˆØ¹' : 'Back' }}
          </button>
          <button type="button" class="btn-primary" (click)="saveQuizSettings()" [disabled]="creatingQuiz" [attr.aria-busy]="creatingQuiz ? 'true' : null">
            <span *ngIf="!creatingQuiz">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Create Quiz' }}</span>
            <span *ngIf="creatingQuiz" class="btn-loading">
              <span class="spinner"></span>
              <span>{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...' : 'Creating...' }}</span>
            </span>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quiz Editor Modal -->
<div class="modal-overlay" *ngIf="showQuizEditorModal">
  <div class="modal-content quiz-editor-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ quizSettings.title || (currentLang === 'ar' ? 'Ù…Ø­Ø±Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Quiz Editor') }}</h3>
      <button type="button" class="modal-close-btn" (click)="closeQuizEditor()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="quiz-info-bar">
        <span *ngIf="quizSettings.full_score > 0">
          <strong>{{ currentLang === 'ar' ? 'Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ' : 'Total Score' }}:</strong> {{ quizSettings.full_score }}
        </span>
        <span *ngIf="quizQuestions.length > 0">
          <strong>{{ currentLang === 'ar' ? 'Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø³Ø¦Ù„Ø©' : 'Questions' }}:</strong> {{ quizQuestions.length }}
        </span>
        <span *ngIf="quizQuestions.length > 0 && quizSettings.full_score > 0">
          <strong>{{ currentLang === 'ar' ? 'Ù†Ù‚Ø§Ø· Ù„ÙƒÙ„ Ø³Ø¤Ø§Ù„' : 'Points per Question' }}:</strong> 
          {{ Math.round((quizSettings.full_score / quizQuestions.length) * 100) / 100 }}
        </span>
      </div>

      <!-- AI Generation Button (for AI mode) -->
      <div class="quiz-actions" *ngIf="quizMode === 'ai' && quizQuestions.length === 0">
        <button type="button" class="btn-primary" (click)="generateAIQuizQuestions()" [disabled]="generatingQuiz">
          <span class="btn-icon" *ngIf="!generatingQuiz">ğŸ¤–</span>
          <span *ngIf="!generatingQuiz">{{ currentLang === 'ar' ? 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„Ø°ÙƒØ§Ø¡ Ø§Ù„Ø§ØµØ·Ù†Ø§Ø¹ÙŠ' : 'Generate Questions with AI' }}</span>
          <span *ngIf="generatingQuiz">{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡...' : 'Generating...' }}</span>
        </button>
        <div class="ai-generating-dhikr" *ngIf="generatingQuiz">
          <div class="dhikr-badge">
            <div class="dhikr-spinner">
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
              <div class="spinner-ring"></div>
            </div>
            <span class="dhikr-icon">âœ¨</span>
            <span class="dhikr-phrase">{{ currentDhikr }}</span>
          </div>
        </div>
      </div>

      <!-- Add Question Button (for manual mode or editing) -->
      <div class="quiz-actions" *ngIf="quizMode === 'manual' || quizQuestions.length > 0">
        <button type="button" class="btn-primary" (click)="addNewQuestion('mcq')" *ngIf="quizSettings.allowed_types.includes('mcq')">
          + {{ currentLang === 'ar' ? 'Ø§Ø®ØªÙŠØ§Ø± Ù…Ù† Ù…ØªØ¹Ø¯Ø¯' : 'Multiple Choice' }}
        </button>
        <button type="button" class="btn-primary" (click)="addNewQuestion('true_false')" *ngIf="quizSettings.allowed_types.includes('true_false')">
          + {{ currentLang === 'ar' ? 'ØµØ­ÙŠØ­/Ø®Ø·Ø£' : 'True/False' }}
        </button>
        <button type="button" class="btn-primary" (click)="addNewQuestion('matching')" *ngIf="quizSettings.allowed_types.includes('matching')">
          + {{ currentLang === 'ar' ? 'Ù…Ø·Ø§Ø¨Ù‚Ø©' : 'Matching' }}
        </button>
        <button type="button" class="btn-primary" (click)="addNewQuestion('ordering')" *ngIf="quizSettings.allowed_types.includes('ordering')">
          + {{ currentLang === 'ar' ? 'ØªØ±ØªÙŠØ¨' : 'Ordering' }}
        </button>
      </div>

      <!-- Questions List -->
      <div class="quiz-questions-list" *ngIf="quizLoading">
        <div class="loading-spinner">
          <span class="spinner"></span>
          <span>{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...' : 'Loading...' }}</span>
        </div>
      </div>
      <div class="quiz-questions-list" *ngIf="!quizLoading && quizQuestions.length === 0">
        <p class="empty-state">{{ currentLang === 'ar' ? 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø¦Ù„Ø© Ø¨Ø¹Ø¯. Ø£Ø¶Ù Ø³Ø¤Ø§Ù„Ø§Ù‹ Ø¬Ø¯ÙŠØ¯Ø§Ù‹.' : 'No questions yet. Add a new question.' }}</p>
      </div>
      <div class="quiz-questions-list" *ngIf="!quizLoading && quizQuestions.length > 0">
        <div *ngFor="let question of quizQuestions; let i = index" class="question-item">
          <div class="question-header">
            <span class="question-number">{{ i + 1 }}.</span>
            <span class="question-type-badge">{{ getQuestionTypeLabel(question.question_type) }}</span>
            <span class="question-points">{{ question.points }} {{ currentLang === 'ar' ? 'Ù†Ù‚Ø·Ø©' : 'points' }}</span>
          </div>
          <div class="question-content">
            <p class="question-prompt">{{ question.prompt }}</p>
            <div class="question-preview" *ngIf="question.question_type === 'mcq' && question.payload.choices">
              <div *ngFor="let choice of question.payload.choices; let j = index" class="choice-preview">
                <span class="choice-label">{{ String.fromCharCode(65 + j) }}.</span>
                <span>{{ choice }}</span>
                <span class="correct-indicator" *ngIf="j === question.payload.correct_index">âœ“</span>
              </div>
            </div>
            <div class="question-preview" *ngIf="question.question_type === 'true_false'">
              <span>{{ question.payload.correct_answer ? (currentLang === 'ar' ? 'ØµØ­ÙŠØ­' : 'True') : (currentLang === 'ar' ? 'Ø®Ø·Ø£' : 'False') }}</span>
            </div>
          </div>
          <div class="question-actions">
            <button type="button" class="btn-icon" (click)="moveQuestionUp(question)" [disabled]="i === 0" [attr.aria-label]="currentLang === 'ar' ? 'ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø¹Ù„Ù‰' : 'Move up'">â¬†ï¸</button>
            <button type="button" class="btn-icon" (click)="moveQuestionDown(question)" [disabled]="i === quizQuestions.length - 1" [attr.aria-label]="currentLang === 'ar' ? 'ØªØ­Ø±ÙŠÙƒ Ù„Ù„Ø£Ø³ÙÙ„' : 'Move down'">â¬‡ï¸</button>
            <button type="button" class="btn-icon" (click)="editQuestion(question)" [attr.aria-label]="currentLang === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„' : 'Edit'">âœï¸</button>
            <button type="button" class="btn-icon delete" (click)="deleteQuestion(question)" [attr.aria-label]="currentLang === 'ar' ? 'Ø­Ø°Ù' : 'Delete'">ğŸ—‘ï¸</button>
          </div>
        </div>
      </div>
    </div>
            <div class="modal-actions">
              <button type="button" class="btn-secondary" (click)="testQuiz()" *ngIf="quizQuestions.length > 0">
                {{ currentLang === 'ar' ? 'Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±' : 'Test Quiz' }}
              </button>
              <button type="button" class="btn-cancel" (click)="closeQuizEditor()">
                {{ currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close' }}
              </button>
            </div>
  </div>
</div>

<!-- Question Editor Modal -->
<div class="modal-overlay" *ngIf="showQuestionEditor && currentQuestion">
  <div class="modal-content question-editor-modal" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ currentQuestion.id ? (currentLang === 'ar' ? 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø³Ø¤Ø§Ù„' : 'Edit Question') : (currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø³Ø¤Ø§Ù„ Ø¬Ø¯ÙŠØ¯' : 'Add New Question') }}</h3>
      <button type="button" class="modal-close-btn" (click)="cancelQuestionEdit()" [attr.aria-label]="currentLang === 'ar' ? 'Ø¥ØºÙ„Ø§Ù‚' : 'Close'">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="form-field">
        <label for="questionPrompt">{{ currentLang === 'ar' ? 'Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„' : 'Question Prompt' }}</label>
        <textarea
          id="questionPrompt"
          class="field-input"
          [(ngModel)]="currentQuestion.prompt"
          [placeholder]="currentLang === 'ar' ? 'Ø£Ø¯Ø®Ù„ Ù†Øµ Ø§Ù„Ø³Ø¤Ø§Ù„ Ù‡Ù†Ø§' : 'Enter question text here'"
          rows="2"
        ></textarea>
      </div>

      <!-- MCQ Options -->
      <div class="form-field" *ngIf="currentQuestion.question_type === 'mcq' && currentQuestion.payload?.choices">
        <label>{{ currentLang === 'ar' ? 'Ø§Ù„Ø®ÙŠØ§Ø±Ø§Øª' : 'Choices' }}</label>
        <p class="field-hint">{{ currentLang === 'ar' ? 'Ø­Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø© Ø¨Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø± Ø§Ù„Ø¯Ø§Ø¦Ø±ÙŠ' : 'Select the correct answer by clicking the radio button' }}</p>
          <div *ngFor="let choice of currentQuestion.payload.choices; let i = index; trackBy: trackByChoiceIndex" class="choice-input-row" [class.correct-answer]="currentQuestion.payload!.correct_index === i">
            <label class="radio-wrapper">
              <input
                type="radio"
                name="correctChoice"
                [value]="i"
                [checked]="currentQuestion.payload!.correct_index === i"
                (change)="currentQuestion.payload!.correct_index = i"
                [attr.aria-label]="(currentLang === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©' : 'Correct answer') + ' ' + String.fromCharCode(65 + i)"
                class="correct-answer-radio"
              />
              <span class="radio-label-text">{{ String.fromCharCode(65 + i) }}.</span>
            </label>
            <input
              type="text"
              class="field-input"
              [value]="currentQuestion.payload!.choices![i]"
              (input)="updateMcqChoice(i, $event)"
              [placeholder]="(currentLang === 'ar' ? 'Ø§Ù„Ø®ÙŠØ§Ø±' : 'Option') + ' ' + String.fromCharCode(65 + i)"
              autocomplete="off"
              spellcheck="false"
            />
            <span class="correct-badge" *ngIf="currentQuestion.payload!.correct_index === i">
              {{ currentLang === 'ar' ? 'âœ“ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©' : 'âœ“ Correct Answer' }}
            </span>
            <button type="button" class="btn-icon" (click)="removeMcqChoice(i)" *ngIf="currentQuestion.payload.choices && currentQuestion.payload.choices.length > 2" [attr.aria-label]="currentLang === 'ar' ? 'Ø­Ø°Ù Ø§Ù„Ø®ÙŠØ§Ø±' : 'Remove choice'">ğŸ—‘ï¸</button>
          </div>
        <button type="button" class="btn-secondary" (click)="addMcqChoice()" *ngIf="currentQuestion.payload.choices && currentQuestion.payload.choices.length < 10">
          + {{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø®ÙŠØ§Ø±' : 'Add Choice' }}
        </button>
      </div>

      <!-- True/False Options -->
      <div class="form-field" *ngIf="currentQuestion.question_type === 'true_false'">
        <label>{{ currentLang === 'ar' ? 'Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø© Ø§Ù„ØµØ­ÙŠØ­Ø©' : 'Correct Answer' }}</label>
        <div class="radio-group">
          <label class="radio-label">
            <input type="radio" name="trueFalse" [value]="true" [(ngModel)]="currentQuestion.payload.correct_answer" />
            {{ currentLang === 'ar' ? 'ØµØ­ÙŠØ­' : 'True' }}
          </label>
          <label class="radio-label">
            <input type="radio" name="trueFalse" [value]="false" [(ngModel)]="currentQuestion.payload.correct_answer" />
            {{ currentLang === 'ar' ? 'Ø®Ø·Ø£' : 'False' }}
          </label>
        </div>
      </div>

      <!-- Matching Options -->
      <div class="form-field" *ngIf="currentQuestion.question_type === 'matching' && currentQuestion.payload?.pairs">
        <label>{{ currentLang === 'ar' ? 'Ø£Ø²ÙˆØ§Ø¬ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©' : 'Matching Pairs' }}</label>
        <div *ngFor="let pair of currentQuestion.payload.pairs; let i = index" class="matching-pair-row">
          <input
            type="text"
            class="field-input"
            [(ngModel)]="pair.left"
            [placeholder]="currentLang === 'ar' ? 'Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙŠØ³Ø±' : 'Left item'"
          />
          <span>â†’</span>
          <input
            type="text"
            class="field-input"
            [(ngModel)]="pair.right"
            [placeholder]="currentLang === 'ar' ? 'Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ø£ÙŠÙ…Ù†' : 'Right item'"
          />
          <button type="button" class="btn-icon" (click)="removeMatchingPair(i)" *ngIf="currentQuestion.payload.pairs && currentQuestion.payload.pairs.length > 2" [attr.aria-label]="currentLang === 'ar' ? 'Ø­Ø°Ù Ø§Ù„Ø²ÙˆØ¬' : 'Remove pair'">ğŸ—‘ï¸</button>
        </div>
        <button type="button" class="btn-secondary" (click)="addMatchingPair()">
          + {{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø²ÙˆØ¬' : 'Add Pair' }}
        </button>
      </div>

      <!-- Ordering Options -->
      <div class="form-field" *ngIf="currentQuestion.question_type === 'ordering' && currentQuestion.payload?.items">
        <label>{{ currentLang === 'ar' ? 'Ø§Ù„Ø¹Ù†Ø§ØµØ± Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­' : 'Items in Correct Order' }}</label>
        <div *ngFor="let item of currentQuestion.payload.items; let i = index; trackBy: trackByOrderingItemIndex" class="ordering-item-row">
          <span class="order-number">{{ i + 1 }}.</span>
          <input
            type="text"
            class="field-input"
            [value]="currentQuestion.payload!.items![i]"
            (input)="updateOrderingItem(i, $event)"
            [placeholder]="(currentLang === 'ar' ? 'Ø§Ù„Ø¹Ù†ØµØ±' : 'Item') + ' ' + (i + 1)"
          />
          <button type="button" class="btn-icon" (click)="removeOrderingItem(i)" *ngIf="currentQuestion.payload.items && currentQuestion.payload.items.length > 2" [attr.aria-label]="currentLang === 'ar' ? 'Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ±' : 'Remove item'">ğŸ—‘ï¸</button>
        </div>
        <button type="button" class="btn-secondary" (click)="addOrderingItem()">
          + {{ currentLang === 'ar' ? 'Ø¥Ø¶Ø§ÙØ© Ø¹Ù†ØµØ±' : 'Add Item' }}
        </button>
        <p class="form-hint">{{ currentLang === 'ar' ? 'Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ Ù‡Ùˆ 1ØŒ 2ØŒ 3... (Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø°ÙŠ Ø£Ø¯Ø®Ù„ØªÙ‡)' : 'Correct order is 1, 2, 3... (the order you entered)' }}</p>
      </div>
    </div>
    <div class="modal-actions">
      <button type="button" class="btn-cancel" (click)="cancelQuestionEdit()">
        {{ currentLang === 'ar' ? 'Ø¥Ù„ØºØ§Ø¡' : 'Cancel' }}
      </button>
      <button type="button" class="btn-primary" (click)="saveQuestion(currentQuestion)" [disabled]="!currentQuestion.prompt || !currentQuestion.prompt.trim() || savingQuestion" [attr.aria-busy]="savingQuestion ? 'true' : null">
        <span *ngIf="!savingQuestion">{{ currentLang === 'ar' ? 'Ø­ÙØ¸' : 'Save' }}</span>
        <span *ngIf="savingQuestion" class="btn-loading">
          <span class="spinner"></span>
          <span>{{ currentLang === 'ar' ? 'Ø¬Ø§Ø±Ù Ø§Ù„Ø­ÙØ¸...' : 'Saving...' }}</span>
        </span>
      </button>
    </div>
  </div>
</div>
