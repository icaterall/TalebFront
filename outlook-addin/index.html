<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Outlook Exam Task Pane</title>
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://appsforoffice.microsoft.com https://res.cdn.office.net; script-src 'self' https://appsforoffice.microsoft.com 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self'; frame-ancestors 'self' https://outlook.office.com https://*.outlook.office.com;"/>
  <script src="https://appsforoffice.microsoft.com/lib/1/hosted/office.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 12px; }
    .q { margin: 12px 0; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
    .ok { color: #10893e; }
    .bad { color: #a4262c; }
    button { padding: 8px 12px; border-radius: 8px; border: 1px solid #ccc; cursor: pointer; }
    .hint { font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <h2>Outlook Practice – Sample Grader</h2>

  <div class="q">
    <strong>Q1.</strong> Create an email with:
    <ul>
      <li>Subject exactly <code>Practice: Quarterly Update</code></li>
      <li><strong>To</strong>: <code>ceo@example.edu</code></li>
      <li><strong>Cc</strong>: <code>hr@example.edu</code></li>
      <li><strong>Bcc</strong>: <code>audit@example.edu</code></li>
    </ul>
    <div class="hint">Tip: You can change recipients/subject in the compose form and re-grade anytime.</div>
  </div>

  <div class="q">
    <strong>Q2.</strong> Email body must contain the keyword: <code>#Q4-Targets</code>
  </div>

  <p><button id="grade">Grade now</button></p>

  <div id="results"></div>

  <script>
    let mailboxItem;

    Office.onReady(() => {
      mailboxItem = Office.context?.mailbox?.item;
      const btn = document.getElementById('grade');
      btn.addEventListener('click', runGrading);
    });

    function setResults(html) {
      document.getElementById('results').innerHTML = html;
    }

    function getAsyncSubject() {
      return new Promise((resolve, reject) => {
        mailboxItem.subject.getAsync(res => res.status === Office.AsyncResultStatus.Succeeded ? resolve(res.value || '') : reject(res.error));
      });
    }

    function getAsyncRecipients(kind) {
      return new Promise((resolve, reject) => {
        const api = { to: mailboxItem.to, cc: mailboxItem.cc, bcc: mailboxItem.bcc }[kind];
        if (!api) return resolve([]);
        api.getAsync(res => {
          if (res.status !== Office.AsyncResultStatus.Succeeded) return reject(res.error);
          const arr = (res.value || []).map(x => (x.emailAddress || '').trim().toLowerCase());
          resolve(arr);
        });
      });
    }

    function getAsyncBodyText() {
      return new Promise((resolve, reject) => {
        mailboxItem.body.getAsync(Office.CoercionType.Text, res => {
          res.status === Office.AsyncResultStatus.Succeeded ? resolve(res.value || '') : reject(res.error);
        });
      });
    }

    async function runGrading() {
      setResults('Grading…');

      try {
        const [subject, toList, ccList, bccList, body] = await Promise.all([
          getAsyncSubject(),
          getAsyncRecipients('to'),
          getAsyncRecipients('cc'),
          getAsyncRecipients('bcc'),
          getAsyncBodyText()
        ]);

        // Targets for this demo (change as you like)
        const wantSubject = 'Practice: Quarterly Update';
        const wantTo = 'ceo@example.edu';
        const wantCc = 'hr@example.edu';
        const wantBcc = 'audit@example.edu';
        const wantKeyword = '#Q4-Targets';

        // Checks
        const s1 = subject.trim() === wantSubject;
        const s2 = toList.includes(wantTo);
        const s3 = ccList.includes(wantCc);
        const s4 = bccList.includes(wantBcc);
        const s5 = (body || '').includes(wantKeyword);

        const passCount = [s1,s2,s3,s4,s5].filter(Boolean).length;

        const line = (ok, label, got) =>
          `<li class="${ok ? 'ok' : 'bad'}">${ok ? '✓' : '✗'} ${label}${got !== undefined ? ` <span class="hint">(got: ${got || '—'})</span>` : ''}</li>`;

        setResults(`
          <h3>Results: ${passCount}/5</h3>
          <ul>
            ${line(s1, `Subject = "${wantSubject}"`, subject)}
            ${line(s2, `To contains ${wantTo}`, toList.join(', '))}
            ${line(s3, `Cc contains ${wantCc}`, ccList.join(', '))}
            ${line(s4, `Bcc contains ${wantBcc}`, bccList.join(', '))}
            ${line(s5, `Body contains keyword ${wantKeyword}`)}
          </ul>
          <p class="hint">Change the email fields and click "Grade now" again.</p>
        `);
      } catch (e) {
        setResults(`<p class="bad">Error: ${e?.message || e}</p>`);
      }
    }
  </script>
</body>
</html>
